<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Martin Thoma" />
        <meta name="copyright" content="Martin Thoma" />
        <link title = "Martin Thoma"
              type  = "application/opensearchdescription+xml"
              rel   = "search"
              href  = "../opensearch.xml">

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Python, Flask, Software Development, Unit Testing, Load Testing, Software Engineering, Code, " />

<meta property="og:title" content="How to Test Flask Applications "/>
<meta property="og:url" content="https://medium.com/analytics-vidhya/how-to-test-flask-applications-aef12ae5181c" />
<meta property="og:description" content="As a data scientist, I need to make my models accessible. I usually deploy models with Flask. As a software engineer, I want to make sure things work as expected by unit testing them. Unit Testing websites or web services is hard for multiple reasons: You have Code-within-Code like HTML ‚Ä¶" />
<meta property="og:site_name" content="Martin Thoma" />
<meta property="og:article:author" content="Martin Thoma" />
<meta property="og:article:published_time" content="2020-07-19T20:00:00+02:00" />
<meta name="twitter:title" content="How to Test Flask Applications ">
<meta name="twitter:description" content="As a data scientist, I need to make my models accessible. I usually deploy models with Flask. As a software engineer, I want to make sure things work as expected by unit testing them. Unit Testing websites or web services is hard for multiple reasons: You have Code-within-Code like HTML ‚Ä¶">
<meta property="og:image" content="logos/flask.png" />
<meta name="twitter:image" content="logos/flask.png" >

        <title>How to Test Flask Applications  ¬∑ Martin Thoma
</title>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../static/print.css" media="print">
        <link rel="stylesheet" type="text/css" href="../static/custom.css" media="screen">

        <!-- MathJax -->
<script type="text/x-mathjax-config">
<!--
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [ ['$$', '$$'], ['\\[','\\]']],
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    processEscapes: true
  }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
// -->
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

        <link href="https://martin-thoma.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Martin Thoma - Full Atom Feed" />
        <link href="https://martin-thoma.com/feeds/index.xml" type="application/rss+xml" rel="alternate" title="Martin Thoma - Full RSS Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8HZ7HBMC9L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8HZ7HBMC9L');
</script>    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top navbar-default">
            <div class="container">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse">
                        <ul class="nav pull-left top-menu navbar-nav">
                            <li><a href=".." style="font-family: 'Monaco', 'Inconsolata', 'Andale Mono', 'Lucida Console', 'Bitstream Vera Sans Mono', 'Courier New', Courier, Monospace;
                        font-size: 20px;" class="navbar-brand" tabindex="-1">Martin Thoma</a>
                            </li>
                        </ul>
                        <ul class="nav pull-right top-menu navbar-nav">
                            <li ><a href="..">Home</a></li>
                            <li ><a href="../categories.html">Categories</a></li>
                            <li ><a href="../tags.html">Tags</a></li>
                            <li ><a href="../archives.html">Archives</a></li>
                            <li><a href="../support-me/">Support me</a></li>
                            <li><form class="navbar-form" action="../search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="search" class="search-query form-control" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-1 col-md-1"></div>
                <div class="col-sm-10 col-md-10">
<!-- article.html -->
<article>
<div class="row">
    <header class="page-header col-sm-10 col-md-10 col-md-offset-2">
    <h1><a href="https://medium.com/analytics-vidhya/how-to-test-flask-applications-aef12ae5181c">How to Test Flask Applications</a></h1>
    </header>
</div>

<div class="row">
    <div class="col-sm-2 col-md-2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div id="toc"><ul><li><a class="toc-href" href="#" title="How to Test Flask Applications">How to Test Flask Applications</a><ul><li><a class="toc-href" href="#my-tiny-flask-app" title="My Tiny Flask App">My Tiny Flask App</a></li><li><a class="toc-href" href="#how-to-test-routes" title="How to test Routes">How to test Routes</a></li><li><a class="toc-href" href="#how-to-deal-with-the-database" title="How to deal with the Database">How to deal with the Database</a><ul><li><a class="toc-href" href="#wait-what-about-testing-the-sql-queries" title="Wait &hellip; what about testing the SQL Queries?">Wait &hellip; what about testing the SQL Queries?</a></li></ul></li><li><a class="toc-href" href="#protected-routes_1" title="Protected Routes">Protected Routes</a><ul><li><a class="toc-href" href="#basic-access-authentication" title="Basic Access Authentication">Basic Access Authentication</a></li><li><a class="toc-href" href="#flask-login" title="Flask Login">Flask Login</a></li></ul></li><li><a class="toc-href" href="#test-jinja2-templates_1" title="Test Jinja2 Templates">Test Jinja2 Templates</a><ul><li><a class="toc-href" href="#problem-1-empty-double-braces" title="Problem 1: Empty Double Braces">Problem 1: Empty Double Braces</a></li><li><a class="toc-href" href="#problem-2-data-structure-confusion" title="Problem 2: Data Structure confusion">Problem 2: Data Structure confusion</a></li><li><a class="toc-href" href="#problem-31-typo-in-variable" title="Problem 3.1: Typo in Variable">Problem 3.1: Typo in Variable</a></li><li><a class="toc-href" href="#problem-32-forgetting-to-pass-variable" title="Problem 3.2: Forgetting to pass Variable">Problem 3.2: Forgetting to pass Variable</a></li><li><a class="toc-href" href="#status-code-testing" title="Status Code Testing">Status Code Testing</a></li><li><a class="toc-href" href="#testing-the-template-context" title="Testing the Template Context">Testing the Template Context</a></li></ul></li><li><a class="toc-href" href="#pytest-recording_1" title="pytest-recording">pytest-recording</a><ul><li><a class="toc-href" href="#block-network-access" title="Block Network Access">Block Network Access</a></li><li><a class="toc-href" href="#record-network-interactions" title="Record Network Interactions">Record Network Interactions</a></li></ul></li><li><a class="toc-href" href="#load-testing_1" title="Load Testing">Load Testing</a></li><li><a class="toc-href" href="#whats-next" title="What&rsquo;s next?">What&rsquo;s next?</a></li></ul></li></ul></div>
        </nav>
    </div>
    <div class="col-sm-8 col-md-8 article-content" id="contentAfterTitle">

            
            <p>As a data scientist, I need to make my models accessible. I usually <a href="https://medium.com/analytics-vidhya/deploying-a-machine-learning-model-on-web-using-flask-and-python-54b86c44e14a">deploy models with Flask</a>. As a software engineer, I want to make sure things work as expected by unit testing them.</p>
<p>Unit Testing websites or web services is hard for multiple reasons: You have Code-within-Code like HTML template engines and SQL. Additionally, you have Databases as dependencies which are pretty hard to mock. In this article you will learn how to deal with those challenges in the case of the Flask web framework. I assume you have used Flask before and that you <a href="https://medium.com/swlh/unit-testing-in-python-basics-21a9a57418a0">know the basics of unit testing in Python</a>.</p>
<h2 id="my-tiny-flask-app">My Tiny Flask App</h2>
<p>In order to make ensure correctness of the following parts, I&rsquo;ve created a tiny Flask app. You can copy <a href="https://github.com/MartinThoma/algorithms/tree/master/medium/flask-testing/example-app">all files from GitHub</a>.</p>
<p>The general structure is this:</p>
<div class="highlight"><pre><span></span><code>example-app
‚îú‚îÄ‚îÄ mini_app
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py  # make the folder a package
‚îÇ   ‚îú‚îÄ‚îÄ app.py       # contains the Flask app object
‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py    # SQLAlchemy models
‚îÇ   ‚îî‚îÄ‚îÄ templates    # HTML / Jinja2 templates
‚îî‚îÄ‚îÄ tests
    ‚îú‚îÄ‚îÄ conftest.py  # General Test configuration
    ‚îî‚îÄ‚îÄ test_app.py  # The actual unit tests
</code></pre></div>
<p>The only file you don&rsquo;t find in there is .envrc which is used with direnv to set environment variables. Its content looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">DB_HOST</span><span class="o">=</span>localhost
<span class="nb">export</span> <span class="nv">DB_DATABASE</span><span class="o">=</span>books
<span class="nb">export</span> <span class="nv">DB_USER</span><span class="o">=</span>root
<span class="nb">export</span> <span class="nv">DB_PASSWORD</span><span class="o">=</span>you_wish_i_forgot
</code></pre></div>
<h2 id="how-to-test-routes">How to test Routes</h2>
<p>Routes typically look like this in Flask:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Third party modules</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/square"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">square</span><span class="p">():</span>
        <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"number"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>The documentation of Flask contains <a href="https://flask.palletsprojects.com/en/1.1.x/testing/">Testing Flask Applications</a> which covers this topic. It especially contains an example how to create a pytest fixture. Imagine a fixture like a way to set things up before your tests and to clean up after the test run. In this simple example, we assume that your application is a proper Python package and called flaskr . You can download an example from Github <a href="https://github.com/pallets/flask/tree/1.1.2/examples/tutorial/flaskr">flask/examples/tutorial/flaskr</a> . The fixture in this simple case looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="c1"># Prepare before your test</span>
    <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">with</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="c1"># Give control to your test</span>
        <span class="k">yield</span> <span class="n">client</span>
    <span class="c1"># Cleanup after the test run.</span>
    <span class="c1"># ... nothing here, for this simple example</span>
</code></pre></div>
<p>pytest fixtures are a bit magical. You can give them as a parameter to the test, but you don&rsquo;t have to execute it. The fixture just has to be discoverable by pytest.</p>
<p>The complete test then looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Third party modules</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># First party modules</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="k">def</span> <span class="nf">test_square</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/square?number=8"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s2">"64"</span> <span class="o">==</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
</code></pre></div>
<p>Instead of putting the fixture in the test directly, you can put them in <code>tests/conftest.py</code>. pytest will find them there and use in all tests. No need to import.</p>
<h2 id="how-to-deal-with-the-database">How to deal with the Database</h2>
<p>Most web applications have a database. When running tests, you want to be certain that the tests don&rsquo;t hit the production database. At the same time, you want something like a database to be there.</p>
<p>I assume that you are using
<a href="https://github.com/pallets/flask-sqlalchemy">flask-sqlalchemy</a>. It is part of
the pallets project and thus an official part of the Flask ecosystem. With that
plugin, you configure your database connection via
<code>app.config["SQLALCHEMY_DATABASE_URI"]</code>. If you override that configuration
string with <code>sqlite://</code>, flask-sqlalchemy will create an in-memory SQLite
database and use that instead of the real database. This is super fast to
create and interact with (see
<a href="https://martin-thoma.com/key-value-stores/#benchmark_1">benchmark</a>).</p>
<p>You can adjust the client fixture like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Third party modules</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># First party modules</span>
<span class="kn">from</span> <span class="nn">mini_app.app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">mini_app.models</span> <span class="kn">import</span> <span class="n">Author</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">app</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># This creates an in-memory sqlite db</span>
    <span class="c1"># See https://martin-thoma.com/sql-connection-strings/</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"SQLALCHEMY_DATABASE_URI"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sqlite://"</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
        <span class="n">author1</span> <span class="o">=</span> <span class="n">Author</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s2">"foo"</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s2">"bar"</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author1</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">client</span>
</code></pre></div>
<p>Now you can easily run your tests against the fake database:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_author</span><span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/author/1"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rv</span><span class="o">.</span><span class="n">json</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"first_name"</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"last_name"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">}</span>
</code></pre></div>
<p>Note that this will become harder the more complex your data becomes and the more data you need to properly test your views.</p>
<h3 id="wait-what-about-testing-the-sql-queries">Wait &hellip; what about testing the SQL Queries?</h3>
<p>You might wonder now how to test the SQL queries. Testing that they work at all should not be necessary if you use SQLAlchemy. And I really recommend to use SQLAlchemy when you use Flask with a relational database. If your queries are too complex for that, you can have a look at Query Builders. Avoid using raw SQL. In most cases it should not be necessary.</p>
<h2 id="protected-routes_1">Protected Routes</h2>
<p>It&rsquo;s pretty common that you have routes which are either protected by <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic Auth</a> or need a form of login. You can essentially also set up a test account in the client fixture and login manually. This requires some work and depends on what exactly you&rsquo;re doing for authentication.</p>
<h3 id="basic-access-authentication">Basic Access Authentication</h3>
<p>You can provide the necessary credentials in the header within the test:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Core Library modules</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>


<span class="k">def</span> <span class="nf">test_protected_route</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">"user:password"</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
    <span class="n">route</span> <span class="o">=</span> <span class="s2">"protected/route"</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"Authorization"</span><span class="p">:</span> <span class="s2">"Basic "</span> <span class="o">+</span> <span class="n">credentials</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">rv</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>
<h3 id="flask-login">Flask Login</h3>
<p>Flask-login is a pretty widespread plugin to handle user session management.
They have a <a href="https://flask-login.readthedocs.io/en/latest/#protecting-views">section about unit
testing</a> in
which they suggest do set the configuration variable <code>LOGIN_DISABLED</code> to
<code>True</code>.</p>
<h2 id="test-jinja2-templates_1">Test Jinja2 Templates</h2>
<p>Before we dive into testing Jinja2 Templates, let&rsquo;s first recap a couple of
things that can go wrong.</p>
<h3 id="problem-1-empty-double-braces">Problem 1: Empty Double Braces</h3>
<p>You wanted to write something, got interrupted and now your template has <code>{{}}</code>
in it. When Jinja tries to render this, you will get</p>
<div class="highlight"><pre><span></span><code>jinja2.exceptions.TemplateSyntaxError: Expected an expression, got 'end of print statement'
</code></pre></div>
<h3 id="problem-2-data-structure-confusion">Problem 2: Data Structure confusion</h3>
<p>You assume <code>number</code> is a string, but it actually is an integer:</p>
<div class="highlight"><pre><span></span><code>{% for digit in number %}
    {{ digit }}
{% endfor %}
</code></pre></div>
<p>You will get a <code>TypeError: 'int' object is not iterable</code>.</p>
<h3 id="problem-31-typo-in-variable">Problem 3.1: Typo in Variable</h3>
<p>Instead of <code>{{ numbers }}</code> you write <code>{{ number }}</code>. This is pretty bad as it
actually does nothing. It is as if the variable number existed and was the
empty string.</p>
<h3 id="problem-32-forgetting-to-pass-variable">Problem 3.2: Forgetting to pass Variable</h3>
<p>You actually wanted to write <code>number</code>, but you forgot to pass it to the
template. The effect is the same, but I think it&rsquo;s an interesting different
cause. This is what happens most often to me.</p>
<h3 id="status-code-testing">Status Code Testing</h3>
<p>By calling a view and making sure that the <code>assert rv.status_code == 200</code> you
can already capture Problem 1 and 2:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_main_route_status_code</span><span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">route</span> <span class="o">=</span> <span class="s2">"/"</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rv</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>
<p>For this reason, make sure that you call each route at least once.</p>
<p>Up to my knowledge, there is not a lot more you can do without getting creative. Let&rsquo;s hope <a href="https://stackoverflow.com/q/62970759/562769">StackOverflow knows more</a>.</p>
<h3 id="testing-the-template-context">Testing the Template Context</h3>
<p>This one needed a lot of trail and error, but I finally managed to get some pytest fixtures with which you have a better control over the variables passed to the templates. I love it üòç</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Core Library modules</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># Third party modules</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">template_rendered</span>

<span class="c1"># First party modules</span>
<span class="kn">from</span> <span class="nn">mini_app.app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">mini_app.models</span> <span class="kn">import</span> <span class="n">Author</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">():</span>
    <span class="sd">"""Create application for the tests."""</span>
    <span class="n">_app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
    <span class="n">_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">()</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

    <span class="n">_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"TESTING"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_app</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># This creates an in-memory sqlite db</span>
    <span class="c1"># See https://martin-thoma.com/sql-connection-strings/</span>
    <span class="n">_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"SQLALCHEMY_DATABASE_URI"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sqlite://"</span>

    <span class="k">with</span> <span class="n">_app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
        <span class="n">author1</span> <span class="o">=</span> <span class="n">Author</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s2">"foo"</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s2">"bar"</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author1</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">_app</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">client</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">captured_templates</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">recorded</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="n">recorded</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

    <span class="n">template_rendered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">recorded</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">template_rendered</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
</code></pre></div>
<p>And this is how you can use it:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_main_route_status_code_number3</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">captured_templates</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">route</span> <span class="o">=</span> <span class="s2">"/?number=3"</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

    <span class="c1"># Sanity checks - it would be a total surprise if this would not hold true</span>
    <span class="k">assert</span> <span class="n">rv</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">captured_templates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">template</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">captured_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"base.html"</span>

    <span class="c1"># Here I test the two values which are passed to the template:</span>
    <span class="k">assert</span> <span class="n">context</span><span class="p">[</span><span class="s2">"number"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">context</span><span class="p">[</span><span class="s2">"square"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span>
</code></pre></div>
<h2 id="pytest-recording_1">pytest-recording</h2>
<p><a href="https://github.com/kiwicom/pytest-recording">pytest-recording</a> is a pytest plugin which integrates <a href="https://pypi.org/project/vcrpy/">vcr.py</a> into pytest. There is also <a href="https://github.com/kiwicom/pytest-recording/issues/52">pytest-vcr</a> and both plugins are not wide-spread. I think pytest-recording is better maintained as <a href="https://github.com/kiwicom/pytest-recording/issues/52#issuecomment-660528322">the author answered within 2 hours</a>.</p>
<h3 id="block-network-access">Block Network Access</h3>
<p>This one is a potential live saver. Just decorate a test with
<code>@pytest.mark.block_network</code> and you can be certain that everything runs
locally. If something tries to make a network access, it is blocked and you get</p>
<div class="highlight"><pre><span></span><code>RuntimeError: Network is disabled
</code></pre></div>
<p>You can also use <a href="https://github.com/miketheman/pytest-socket">pytest-socket</a> to disable network access.</p>
<h3 id="record-network-interactions">Record Network Interactions</h3>
<p>You can decorate a test with <code>@pytest.mark.vcr()</code>. Run <code>pytest
--record-mode=rewrite</code></p>
<h2 id="load-testing_1">Load Testing</h2>
<p>Testing Flask apps is not only about testing the used functions and routes, but also about knowing your limits. You want to know what actually breaks and when it breaks when you get tons of users.</p>
<p><a href="https://jmeter.apache.org/">Apache JMeter</a> is maybe one of the most well-known
applications for load testing. Being a Python user, I prefer to stay in Python
and for this reason I&rsquo;ll briefly present <a href="https://locust.io/">Locust</a>. You can
create a <code>locustfile.py</code> with this content:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Third party modules</span>
<span class="kn">from</span> <span class="nn">locust</span> <span class="kn">import</span> <span class="n">HttpUser</span><span class="p">,</span> <span class="n">between</span><span class="p">,</span> <span class="n">task</span>


<span class="k">class</span> <span class="nc">MyWebsiteUser</span><span class="p">(</span><span class="n">HttpUser</span><span class="p">):</span>
    <span class="n">wait_time</span> <span class="o">=</span> <span class="n">between</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

    <span class="nd">@task</span>
    <span class="k">def</span> <span class="nf">load_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
</code></pre></div>
<p>Then you run</p>
<div class="highlight"><pre><span></span><code>pip install locust
locust -f locustfile.py --host<span class="o">=[</span>https://your-website.com<span class="o">](</span>https://martin-thoma.com<span class="o">)</span>
</code></pre></div>
<p>It then gives output like this:</p>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/locust.png"><img alt="I've chosen to simulate 100 users" src="../images/2020/07/locust.png" style="width: 512px;"/></a>
<figcaption class="text-center">I've chosen to simulate 100 users</figcaption>
</figure>
<p>There is a lot more to make this realistic than just calling a &ldquo;static&rdquo; endpoint. We want the users to interact in some way. So we can define a <a href="https://docs.locust.io/en/stable/writing-a-locustfile.html#sequentialtaskset-class">SequentialTaskSet</a>. At this point, I will leave it up to you to decide if you want to know more about load testing with Locust.</p>
<p>Maybe it&rsquo;s not necessary for you.</p>
<p>If you have a web service live, you should have another service which regularly pings yours and checks if it is still alive. The latency of the answer can be measured and should be monitored. If you don&rsquo;t expect a crazy amount of calls and if you have auto scaling enabled anyway, it&rsquo;s perfectly reasonable not to run a load test. Just monitor your API behavior and act if you really need to.</p>
<h2 id="whats-next">What&rsquo;s next?</h2>
<p>You already know <a href="https://medium.com/swlh/unit-testing-in-python-basics-21a9a57418a0">the basics of Unit Testing in Python</a> and <a href="https://levelup.gitconnected.com/unit-testing-in-python-mocking-patching-and-dependency-injection-301280db2fed">how to patch and create mocks</a>. In this parts you learned how to deal with the special challenges of Flask applications.</p>
<p>In future articles, I will present:</p>
<ul>
<li>
<p>How to structure Unit Tests</p>
</li>
<li>
<p>tox and nox</p>
</li>
<li>
<p>CI-Pipelines</p>
</li>
<li>
<p>Test Automation</p>
</li>
<li>
<p>Property-based Testing</p>
</li>
<li>
<p>Mutation Testing</p>
</li>
</ul>
            
            <div id="disqus_thread" class="no-print"></div>
<script>
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');

        s.src = '//martinthoma.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

            <hr/>
        </div>
        <section>
        <div class="col-sm-2 col-md-2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2020-07-19T20:00:00+02:00">Jul 19, 2020</time>
            <br/>
            by <a rel="author" class="vcard author post-author" itemprop="author" href="../author/martin-thoma/"><span class="fn" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name">Martin Thoma</span></span></a>
            <h4>Category</h4>
            <a class="category-link" href="../categories.html#code-ref">Code</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="../tags.html#flask-ref">Flask
                    <span>6</span>
</a></li>
                <li><a href="../tags.html#load-testing-ref">Load Testing
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#python-ref">Python
                    <span>141</span>
</a></li>
                <li><a href="../tags.html#software-development-ref">Software Development
                    <span>15</span>
</a></li>
                <li><a href="../tags.html#software-engineering-ref">Software Engineering
                    <span>19</span>
</a></li>
                <li><a href="../tags.html#unit-testing-ref">Unit Testing
                    <span>6</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="https://twitter.com/_martinthoma" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="mailto:info@martin-thoma.de" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
    <a href="https://github.com/MartinThoma" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://stackoverflow.com/users/562769/martin-thoma" title="My Stackoverflow Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-stackoverflow sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="col-sm-1 col-md-1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer class="no-print">
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-subtitle"><span class="site-name">Martin Thoma</span> - A blog about Code, the Web and Cyberculture</li>
        <li><a href="https://martin-thoma.com/email-subscription">E-mail subscription</a></li>
        <li><a href="https://martin-thoma.com/feeds/index.xml">RSS-Feed</a></li>
        <li><a href="http://www.martin-thoma.de/privacy.htm">Privacy/Datenschutzerkl&auml;rung</a></li>
        <li><a href="http://www.martin-thoma.de/impressum.htm">Impressum</a></li>
        <li class="elegant-power">Powered by
            <a href="https://blog.getpelican.com/" title="Pelican Home Page" tabindex="-1">Pelican</a>.
            Theme: <a href="https://elegant.oncrashreboot.com" title="Theme Elegant Home Page" tabindex="-1">Elegant</a>
            by <a href="https://www.oncrashreboot.com/" title="Talha Mansoor Home Page" tabindex="-1">Talha Mansoor</a></li>
    </ul>
</div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
        <script>
(function(){
    'use strict';

    /*
    Create intra-page links
    Requires that your headings already have an `id` attribute set
    For every heading in your page, this adds a little anchor link `#` that you can click to get a permalink to the heading.
    Ignores `h1`, because you should only have one per page.
    The text content of the tag is used to generate the link, so it will fail "gracefully-ish" if you have duplicate heading text.

    Credit: https://gist.github.com/SimplGy/a229d25cdb19d7f21231
     */

    var headingNodes = [], results, link,
        tags = ['h2', 'h3', 'h4', 'h5', 'h6'];

    tags.forEach(function(tag){
        var contentTag = document.getElementById('contentAfterTitle');
      results = contentTag.getElementsByTagName(tag);
      Array.prototype.push.apply(headingNodes, results);
    });

    headingNodes.forEach(function(node){
      link = document.createElement('a');
      link.className = 'deepLink';
      link.textContent = ' ¬∂';
      link.href = '#' + node.getAttribute('id');
      node.appendChild(link);
    });

  })();
</script>
    </body>
    <!-- Theme: Elegant built for Pelican
    License : https://elegant.oncrashreboot.com -->
</html>