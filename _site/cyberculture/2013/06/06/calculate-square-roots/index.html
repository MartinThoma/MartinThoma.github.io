<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Calculate square roots</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Martin Thoma</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Calculate square roots</h2>
<p class="meta">06 Jun 2013</p>

<div class="post">
<p>Suppose you have an equation like this:</p>

<p>$x<sup>2</sup> = a, \;\;\;\; a \in \mathbb{R}_{\geq 0}$</p>

<p>Your task is to compute the solution $x \in \mathbb{R}_{\geq 0}$.</p>

<p>How do you solve this algorithmically?</p>

<h2>Input and output</h2>


<p>Write a program that takes two parameters $a, n \in \mathbb{N}_{\geq 1}$:</p>

<ul>
  <li>$a$: The number you should take the square root of. $a$ is not bigger than 65535. To make this a little bit simpler, you can also assume that $a$ is an integer.</li>
  <li>$n$: Number of iterations you may use</li>
</ul>


<p>Your program should output exactly one positive floating point number. The decimal separator is a point. At the end of the number should be a newline character <code>\n</code>.</p>

<h2>Reference code</h2>


<p>[c]
// Thanks to http://stackoverflow.com/a/15363123/562769</p>

<h1>include &lt;stdio.h></h1>

<h1>include &lt;gmp.h></h1>

<p>int main(int argc, char *argv[]) {
    mpf_t res, a;
    mpf_set_default_prec(1000000); // Increase this number.
    mpf_init(res);
    mpf_init(a);
    mpf_set_str(a, "2", 10);
    mpf_sqrt (res, a);
    gmp_printf("%.1000Ff\n\n", res); // Increase this number.
    return 0;
}
[/c]</p>

<p>You need <a href="http://gmplib.org/manual">GMP</a> (<code>libgmp-dev</code>) to compile this.</p>

<p>Compile it like this:</p>

<p>[bash]gcc sqrt-reference.c  -lgmp -lm -O0 -g3 -o reference.out[/bash]</p>

<p>This is the script I use to get the number of correct digits:</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="k">def</span> <span class="nf">getScore</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;./reference.out &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &gt; reference.txt&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;./&quot;</span> <span class="o">+</span> <span class="n">program</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &gt; result.txt&quot;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;reference.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;result.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">points</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">areEqual</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">reference</span><span class="p">[</span><span class="n">points</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="n">points</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">reference</span><span class="p">[</span><span class="n">points</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="n">points</span><span class="p">]:</span>
            <span class="n">points</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">points</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c"># decimal point</span>
    <span class="k">return</span> <span class="n">points</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
     
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>
     
    <span class="c"># Add more options if you like</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;--program&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;program&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;your program&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;calculate squre root of a&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;maximum n iterations&quot;</span><span class="p">)</span>
     
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
 
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Points for a=</span><span class="si">%i</span><span class="s"> and n=</span><span class="si">%i</span><span class="s">: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">getScore</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">program</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">)))</span>
</code></pre></div>




<h2>Newton's method</h2>


<p>How should be choose the initial value? I thought $\frac{a}{2}$ could be ok. In a good implementation you'll probably do this with a lookup table.</p>

<p>With long double:
[cpp]</p>

<h1>include <iostream></h1>

<h1>include <cmath></h1>

<p>using namespace std;</p>

<p>long double newton(int a, int n) {
    long double x = ((long double)a)/2;
    for (int i=0; i&lt;n; i++) {
        x = x - (x<em>x - a)/(2</em>x);
    }
    return x;
}</p>

<p>int main(int argc, char *argv[]) {
    if (argc != 3) {
        cout &lt;&lt; "Please enter exactly two arguments." &lt;&lt; endl;
        return 1;
    }
    int a = atoi(argv[1]);
    int n = atoi(argv[2]);
    printf("%.80Lf\n", newton(a, n));
    return 0;
}
[/cpp]</p>

<p>I failed to convert this to a version that uses GMP :-/</p>

<p>But it converges quite fast:</p>

<p>[caption id="attachment_69511" align="aligncenter" width="512"]<a href="http://martin-thoma.com/wp-content/uploads/2013/06/newton-correct-digits.png"><img src="http://martin-thoma.com/wp-content/uploads/2013/06/newton-correct-digits.png" alt="Newtons method for calculating square roots" width="512" height="235" class="size-full wp-image-69511" /></a> Newtons method for calculating square roots[/caption]</p>

<h2>Exponential identity</h2>


<p>According to Wikipedia (Source: <a href="http://en.wikipedia.org/wiki/Methods_of_computing_square_roots#Exponential_identity">Methods of computing square roots</a>) many calculators use the following identity:</p>

<p>$\displaystyle \sqrt{a} = e^{\frac{1}{2}\ln a}$</p>

<p>But to calculate this, you need to be able to calculate $e<sup>x</sup>$ for $x \in \mathbb{R}<em>{\geq 0}$ and $\ln(a)$ for $a \in \mathbb{R}</em>{\geq 0}$.</p>

<p>I've used the definition of $e<sup>x</sup>$ to calculate $e<sup>x</sup>$:
$\displaystyle e<sup>x</sup> := \sum_{i = 0}^\infty \frac{x<sup>i</sup>}{i!}$</p>

<p>and:</p>

<p>$\displaystyle \ln(1+x) =- \sum_{k=0}^\infty \frac{(-x)^{k+1}}{k+1}$</p>

<p>So I gave it a try:</p>

<p>[cpp]</p>

<h1>include <iostream></h1>

<h1>include <cmath></h1>

<p>using namespace std;</p>

<p>long double ln(int S, int n) {
    long double tmp = S - 1;
    long double result = tmp;
    long double sign = 1.0;
    for (int i=2; i&lt;n/2; i++) {
        tmp <em>= (S-1);
        sign </em>= -1;
        result += sign*tmp/i;
    }
    return result;
}</p>

<p>long double e(long double x, int n) {
    long double numerator = 1;
    long double denominator = 1;
    long double result = 1;
    for (int i=1; i&lt;n/2; i++) {
        numerator <em>= x;
        denominator </em>= i;
        result += numerator/denominator;
    }
    return result;
}</p>

<p>long double sqrt(int a, int n) {
    return e(ln(a, n)*0.5, n);
}</p>

<p>int main(int argc, char *argv[]) {
    if (argc != 3) {
        cout &lt;&lt; "Please enter exactly two arguments." &lt;&lt; endl;
        return 1;
    }
    int a = atoi(argv[1]);
    int n = atoi(argv[2]);
    printf("%.80Lf\n", sqrt(a, n));
    return 0;
}
[/cpp]</p>

<p>This converges VERY slow: For $a = 2$</p>

<ul>
  <li>$n=1$: 1 digit correct</li>
  <li>$n=10$: 1 digit correct</li>
  <li>$n=100$: 2 digits correct</li>
  <li>$n=1000$: 4 digit correct</li>
  <li>$n=10,000$: 5 digit correct</li>
  <li>$n=100,000$: 5 digit correct</li>
  <li>$n=1,000,000$: 6 digit correct</li>
</ul>


<p>Ok, lets take a better Taylor series for calculating $e<sup>x</sup>$:
$\displaystyle e<sup>x</sup> = \sum_{k=0}^\infty \frac{x^{-1+2 k} (2 \cdot k+x)}{(2\cdot k)!}$</p>

<p>This didn't change anything! I'm very surprised ... as I've calculated $\pi$ for another article, changing the series to something similar improved the speed of convergence drastically.</p>

<h2>See also</h2>


<ul>
  <li>StackOverflow: <a href="http://stackoverflow.com/a/12304868/562769">How does the computer calculate Square roots?</a></li>
  <li><a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">Intel&reg; 64 and IA-32 Architectures Software Developer&rsquo;s Manual</a>: FSQRT, SQRTPS, SQRTSS</li>
  <li><a href="https://github.com/MartinThoma/algorithms/tree/master/square-root-calculation">Source code</a> of this article</li>
</ul>


<p>Feel free to add a program that calculates square roots. When they are interesting, I'll probably add them to this article.</p>


<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
</div>

            <div class="footer">
    <div class="contact">
      <p>
        Martin<br />
        What You Are<br />
        you@example.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="https://github.com/yourusername">github.com/yourusername</a><br />
        <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
      </p>
    </div>
  </div>

        </div>
    </body>
</html>
