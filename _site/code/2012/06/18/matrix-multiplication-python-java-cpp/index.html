<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Part I: Performance of Matrix multiplication in Python, Java and C++</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Martin Thoma</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Part I: Performance of Matrix multiplication in Python, Java and C++</h2>
<p class="meta">18 Jun 2012</p>

<div class="post">
<div class="info">This is Part I of my matrix multiplication series. <a href="http://martin-thoma.com/matrix-multiplication-python-java-cpp/">Part I</a> was about simple matrix multiplication algorithms and <a href="http://martin-thoma.com/strassen-algorithm-in-python-java-cpp/">Part II</a> was about the Strassen algorithm.
<a href="part-iii-matrix-multiplication-on-multiple-cores-in-python-java-and-c">Part III</a> is about parallel matrix multiplication.</div>


<p>This post is about simple implementations of matrix multiplications. The goal of this post is to find out how easy it is to implement a matrix multiplication in Python, Java and C++. Additionally, I want to get to know how good these solutions are.</p>

<p>The second post will be an implementation of the Strassen algorithm for matrix multiplication. <a href="http://en.wikipedia.org/wiki/Strassen_algorithm">Strassen algorithm</a> does matrix multiplication in $\cal O(n^{log_2(7)+o(1)}) \approx \cal O(n^{2.807})$ instead of $\cal O(n<sup>3</sup>)$. I am quite sure this will outperform almost every other change. See Part II: <a href="http://martin-thoma.com/strassen-algorithm-in-python-java-cpp/">The Strassen algorithm in Python, Java and C++</a>.</p>

<p>The third post will be about parallel programming. I have two cores and I want to see if it will be significantly faster if I use both of them.</p>

<h2>The implementations</h2>


<p>I will post all scripts for this test and I've added a <a href="https://github.com/MartinThoma/matrix-multiplication">GIT repository</a>, so feel free to test it on your machine. I am also happy if you post some of your solutions with running times :-) I am quite sure that my Java and C++ code can be written much better. If you know how, please leave a comment.
If you know other languages, you could create a script for these. I focus on Python, Java and C++ as they are very often used.</p>

<p>I have implemented these three types of algorithms for this post:</p>

<ul>
    <li><strong>ijk-algorithm</strong>: This is a simple, straight forward implementation of a matrix multiplication. I've used the definition of matrix multiplication. I didn't use multiple threads.</li>
    <li><strong>ikj-algorithm</strong>: just like the ijk-algorithm, but I've switched two of the three the for-loops.</li>
    <li><strong>Library-functions</strong>: I always prefer libraries over self-implemented solutions. I think they are faster than anything I could come up with in a reasonable amount of time.</li>
</ul>


<p>If you post a solution, please consider these restrictions:</p>

<ul>
    <li><strong>Input</strong>: The input file should get passed with the parameter <code>-i</code>, e.g.: 
    <code>python -i 2000.in</code> or <code>java Shell -i 2000.in</code></li>
    <li>The standard value for the command line parameter -i should be "2000.in" (a $2000 \times 2000$ matrix)</li>
    <li>The user should <em>not</em> have to give the size of the matrix!</li>
    <li>The two square-matrices that should get multiplied are ...
    <ul>
    <li>... read from a text-file.</li>
    <li>... represented like this:
        <ul>
        <li>Every line of one matrix is one line in the text-file.</li>
        <li>Newlines are only "\n".</li>
        <li>Every number is separated by "\t".</li>
        <li>The both matrices are separated by one newline.</li>
        </ul>
    </li>
    </ul>
    </li>
    <li><strong>Output</strong>: The result has to get printed to standard output.</li>
    <li>The result has to be formatted like the input (tabs for separation of number, \n for marks a new line)</li>
</ul>




<h2>The Tests</h2>


<p>I will check the speed of a multiplication of two big matrices following for Python, Java and C++ for all algorithms like this:</p>

<p>[bash]time python scriptABC.py -i ../2000.in > result.txt
diff result.txt bigMatrix.out[/bash]</p>

<p>The <code>bigMatrix.out</code> was produced by the Python ijk-implementation. I make the diff to test if the result is correct.</p>

<h2>The Setting</h2>


<p>I created two "random" matrices $A, B \in \mathbb{N}^{2000 \times 2000}$ with this script. The file that was created needs about 29.7 MB and is also in the GIT-Hub repository. But you can also create the matrices with this script:</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">createRandomMatrix</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">maxVal</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c"># I don&#39;t want to get Java / C++ into trouble</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">maxVal</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">matrix</span>

<span class="k">def</span> <span class="nf">saveMatrix</span><span class="p">(</span><span class="n">matrixA</span><span class="p">,</span> <span class="n">matrixB</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">matrixA</span><span class="p">,</span> <span class="n">matrixB</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">matrixA</span> <span class="o">=</span> <span class="n">createRandomMatrix</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">matrixB</span> <span class="o">=</span> <span class="n">createRandomMatrix</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">saveMatrix</span><span class="p">(</span><span class="n">matrixA</span><span class="p">,</span> <span class="n">matrixB</span><span class="p">,</span> <span class="s">&quot;2000.in&quot;</span><span class="p">)</span>
</code></pre></div>


<p>All scripts are tested on my computer:</p>

<table>
<tr>
<td colspan="2" style="background-color:#cdcdcd">Acer TravelMate 5735Z</td>
</tr>
<tr>
<td style="background-color:#efefef">CPU</td>
<td>2x Pentium(R) Dual-Core CPU T4500 @2.30GHz</td>
</tr>
<tr>
<td style="background-color:#efefef">RAM</td>
<td>4 GB</td>
</tr>
<tr>
<td style="background-color:#efefef">Video Card</td>
<td>Intel GMA 4500MHD</td>
</tr>
<tr>
<td style="background-color:#efefef">System</td>
<td>Ubuntu 10.10.04 LTS</td>
</tr>
</table>




<h2>Python</h2>


<p>I've used Python 2.6.5.</p>

<h3>ijk-algorithm</h3>




<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;2000.in&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s">&quot;input file with two matrices&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">A</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">B</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span>

<span class="k">def</span> <span class="nf">printMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">standardMatrixProduct</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">C</span>

<span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">standardMatrixProduct</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</code></pre></div>


<p>[bash]real  56m49.266s
user    56m30.524s
sys 0m2.980s[/bash]</p>

<h3>ikj-algorithm</h3>




<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">ikjMatrixProduct</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">C</span>
</code></pre></div>


<p>[bash]real  44m36.507s
user    44m13.458s
sys 0m2.000s[/bash]</p>

<h3>Psyco ikj-algorithm</h3>


<p><a href="http://en.wikipedia.org/wiki/Psyco">Psyco</a> is a just in time compiler, which makes my scripts MUCH faster. It is very simple to use. Add these two lines at the top of the ikj-script:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">psyco</span>
<span class="n">psyco</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
</code></pre></div>


<p>[bash]real  6m14.820s
user    6m12.959s
sys 0m0.620s[/bash]</p>

<p>Amazing, isn't it?</p>

<h3>Libraries</h3>


<h4>NumPy</h4>


<p>NumPy-Version: 1.3.0 (Current version is 1.6.2, see <a href="http://en.wikipedia.org/wiki/NumPy">Wiki</a>)</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;2000.in&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s">&quot;input file with two matrices&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">A</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">B</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span>

<span class="k">def</span> <span class="nf">printMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>

<span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="c"># easy and intuitive, isn&#39;t it?</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</code></pre></div>


<p>[bash]real  1m38.425s
user    1m36.066s
sys 0m0.520s[/bash]</p>

<h4>SciPy</h4>


<p>You might need to install <code>python-scitools</code>.</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;2000.in&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s">&quot;input file with two matrices&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">A</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">B</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span>

<span class="k">def</span> <span class="nf">printMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>

<span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="c"># easy and intuitive, isn&#39;t it?</span>
<span class="n">printMatrix</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</code></pre></div>


<p>[bash]real  1m35.795s
user    1m33.438s
sys 0m0.488s[/bash]</p>

<h3>Conclusion for Python</h3>


<p>[caption id="attachment_28301" align="aligncenter" width="512"]<a href="http://martin-thoma.com/wp-content/uploads/2012/06/python-execution-times.png"><img src="http://martin-thoma.com/wp-content/uploads/2012/06/python-execution-times.png" alt="Python execution times for matrix multiplication" title="Python execution times for matrix multiplication" width="512" height="315" class="size-full wp-image-28301" /></a> Python execution times for matrix multiplication[/caption]
Using NumPy is by far the easiest and fastest option. I've needed about five minutes for each of the non-library scripts and about 10 minutes for the NumPy/SciPy scripts.</p>

<p>By the way, it is useless to combine Psyco and NumPy. It gets a little bit faster (1 minute and 28 seconds), but this could also be a random effect. If you execute it many times, you will see that the execution time is never the same.</p>

<h2>Java</h2>


<p>I am using this Java version:
[bash]$ java -version
java version "1.6.0_20"
OpenJDK Runtime Environment (IcedTea6 1.9.13) (6b20-1.9.13-0ubuntu1~10.04.1)
OpenJDK Server VM (build 19.0-b09, mixed mode)[/bash]</p>

<h3>ijk-algorithm</h3>


<p>[java]import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import java.util.ArrayList;</p>

<p>public class Shell {
    static List&lt;ArrayList&lt;ArrayList<Integer>>> read(String filename) {
        ArrayList&lt;ArrayList<Integer>> A = new ArrayList&lt;ArrayList<Integer>>();
        ArrayList&lt;ArrayList<Integer>> B = new ArrayList&lt;ArrayList<Integer>>();</p>

<pre><code>    String thisLine;

    try {
        BufferedReader br = new BufferedReader(
                new FileReader(filename));

        // Begin reading A
        while ((thisLine = br.readLine()) != null) {
            if (thisLine.trim().equals("")) {
                break;
            } else {
                ArrayList&lt;Integer&gt; line = new ArrayList&lt;Integer&gt;();
                String[] lineArray = thisLine.split("\t");
                for (String number : lineArray) {
                    line.add(Integer.parseInt(number));
                }
                A.add(line);
            }
        }

        // Begin reading B
        while ((thisLine = br.readLine()) != null) {
            ArrayList&lt;Integer&gt; line = new ArrayList&lt;Integer&gt;();
            String[] lineArray = thisLine.split("\t");
            for (String number : lineArray) {
                line.add(Integer.parseInt(number));
            }
            B.add(line);
        }
        br.close();
    } catch (IOException e) {
        System.err.println("Error: " + e);
    }

    List&lt;ArrayList&lt;ArrayList&lt;Integer&gt;&gt;&gt; res = new LinkedList&lt;ArrayList&lt;ArrayList&lt;Integer&gt;&gt;&gt;();
    res.add(A);
    res.add(B);
    return res;
}

static int[][] ijkAlgorithm(ArrayList&lt;ArrayList&lt;Integer&gt;&gt; A,
        ArrayList&lt;ArrayList&lt;Integer&gt;&gt; B) {
    int n = A.size();

    // initialise C
    int[][] C = new int[n][n];

    for (int i = 0; i &lt; n; i++) {
        for (int j = 0; j &lt; n; j++) {
            for (int k = 0; k &lt; n; k++) {
                C[i][j] += A.get(i).get(k) * B.get(k).get(j);
            }
        }
    }
    return C;
}

static void printMatrix(int[][] matrix) {
    for (int[] line : matrix) {
        int i = 0;
        StringBuilder sb = new StringBuilder(matrix.length);
        for (int number : line) {
            if (i != 0) {
                sb.append("\t");
            } else {
                i++;
            }
            sb.append(number);
        }
        System.out.println(sb.toString());
    }
}

public static void main(String[] args) {
    String filename;
    if (args.length &lt; 2) {
        filename = "2000.in";
    } else {
        filename = args[1];
    }
    List&lt;ArrayList&lt;ArrayList&lt;Integer&gt;&gt;&gt; matrices = read(filename);
    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; A = matrices.get(0);
    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; B = matrices.get(1);
    int[][] C = ijkAlgorithm(A, B);
    printMatrix(C);
}
</code></pre>

<p>}[/java]</p>

<p>[bash]real  27m21.295s
user    26m53.877s
sys 0m4.368s[/bash]</p>

<p>Note: Java is not C++! If you use <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Vector.html">Vector</a> instead of <a href="http://docs.oracle.com/javase/6/docs/api/java/util/ArrayList.html">ArrayList</a>, you get these results:
[bash]real  82m26.754s
user    80m42.003s
sys 0m24.598s[/bash]
One reason might be that Vector is synchronized.</p>

<h3>ikj-algoirthm</h3>


<p>I've only switched line 60 and line 61.
[bash]real  2m9.478s
user    1m26.369s
sys 0m39.162s[/bash]</p>

<h3>Library: JAMA</h3>


<p>I've searched in Google for "java matrix multiplication". The first 10 results were only implementations of the ijk-algorithm. Although the ijk-algorithm is very easy, most of the results were only questions where people tried to implement it.</p>

<p>After some search (20 minutes minimum) I've found <a href="http://math.nist.gov/javanumerics/jama/">JAMA</a>. They also have a <a href="http://math.nist.gov/javanumerics/jama/doc/">documentation</a>. You might need to install this for the following code:
[bash]sudo apt-get install libjama-*[/bash]</p>

<p>[java]import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;</p>

<p>import Jama.Matrix;</p>

<p>public class Shell {
    static List&lt;ArrayList&lt;ArrayList<Double>>> read(String filename) {
        ArrayList&lt;ArrayList<Double>> A = new ArrayList&lt;ArrayList<Double>>();
        ArrayList&lt;ArrayList<Double>> B = new ArrayList&lt;ArrayList<Double>>();</p>

<pre><code>    String thisLine;

    try {
        BufferedReader br = new BufferedReader(new FileReader(filename));

        // Begin reading A
        while ((thisLine = br.readLine()) != null) {
            if (thisLine.trim().equals("")) {
                break;
            } else {
                ArrayList&lt;Double&gt; line = new ArrayList&lt;Double&gt;();
                String[] lineArray = thisLine.split("\t");
                for (String number : lineArray) {
                    line.add((double) Integer.parseInt(number));
                }
                A.add(line);
            }
        }

        // Begin reading B
        while ((thisLine = br.readLine()) != null) {
            ArrayList&lt;Double&gt; line = new ArrayList&lt;Double&gt;();
            String[] lineArray = thisLine.split("\t");
            for (String number : lineArray) {
                line.add((double) Integer.parseInt(number));
            }
            B.add(line);
        }
    } catch (IOException e) {
        System.err.println("Error: " + e);
    }

    List&lt;ArrayList&lt;ArrayList&lt;Double&gt;&gt;&gt; res = new LinkedList&lt;ArrayList&lt;ArrayList&lt;Double&gt;&gt;&gt;();
    res.add(A);
    res.add(B);
    return res;
}

static int[][] ijkAlgorithm(ArrayList&lt;ArrayList&lt;Integer&gt;&gt; A,
        ArrayList&lt;ArrayList&lt;Integer&gt;&gt; B) {
    int n = A.size();

    // initialise C
    int[][] C = new int[n][n];

    for (int i = 0; i &lt; n; i++) {
        for (int j = 0; j &lt; n; j++) {
            for (int k = 0; k &lt; n; k++) {
                C[i][j] += A.get(i).get(k) * B.get(k).get(j);
            }
        }
    }
    return C;
}

static void printMatrix(Matrix matrix, int n) {
    for (int i = 0; i &lt; n; i++) {
        for (int j = 0; j &lt; n; j++) {
            if (j != 0) {
                System.out.print("\t");
            }
            System.out.printf("%.0f", matrix.get(i, j));
        }
        System.out.println("");
    }
}

public static void main(String[] args) {
    String filename;
    if (args.length &lt; 2) {
        filename = "2000.in";
    } else {
        filename = args[1];
    }
    List&lt;ArrayList&lt;ArrayList&lt;Double&gt;&gt;&gt; matrices = read(filename);
    ArrayList&lt;ArrayList&lt;Double&gt;&gt; A = matrices.get(0);
    ArrayList&lt;ArrayList&lt;Double&gt;&gt; B = matrices.get(1);
    int n = A.size();
    double[][] Aarray = new double[n][n];
    double[][] Barray = new double[n][n];
    for (int i = 0; i &lt; n; i++) {
        for (int j = 0; j &lt; n; j++) {
            Aarray[i][j] = A.get(i).get(j);
            Barray[i][j] = B.get(i).get(j);
        }
    }
    Matrix AM = new Matrix(Aarray);
    Matrix BM = new Matrix(Aarray);
    Matrix CM = AM.times(BM);

    printMatrix(CM, n);
}
</code></pre>

<p>}[/java]</p>

<p>[bash]real  1m36.506s
user    0m51.367s
sys 0m45.043s[/bash]</p>

<p>It took me about two hours to get it work. I had to add the JAMA-JAR to eclipse, export my project as a JAR and run it with
[bash]time java -jar jama-shell.jar -i ../2000.in > jama-result.out[/bash]</p>

<p>I still have no idea how to compile it with bash only.</p>

<h3>Conclusion for Java</h3>


<p>[caption id="attachment_28331" align="aligncenter" width="512"]<a href="http://martin-thoma.com/wp-content/uploads/2012/06/java-execution-time.png"><img src="http://martin-thoma.com/wp-content/uploads/2012/06/java-execution-time.png" alt="Java execution times for matrix multiplication" title="Java execution times for matrix multiplication" width="512" height="287" class="size-full wp-image-28331" /></a> Java execution times for matrix multiplication[/caption]</p>

<p>You should definitely know if some Java-datastructures are synchronised or not. And you should know how the computer / caches work.</p>

<h2>C++</h2>


<p>I have gcc 4.4.3 and compiled everything with these options:
[bash]g++ -std=c++98 -Wall -O3 -g myScript.cpp -o $(PROBLEM).out -pedantic[/bash]</p>

<h3>ijk-algorithm</h3>


<p>[cpp]#include <sstream></p>

<h1>include <string></h1>

<h1>include <fstream></h1>

<h1>include <iostream></h1>

<h1>include <vector></h1>

<p>using namespace std;</p>

<p>struct Result {
    vector&lt; vector<int> > A;
    vector&lt; vector<int> > B;
};</p>

<p>Result read(string filename) {
    vector&lt; vector<int> > A, B;
    Result ab;
    string line;
    ifstream infile;
    infile.open (filename.c_str());</p>

<pre><code>int i = 0;
while (getline(infile, line) &amp;amp;&amp;amp; !line.empty()) {
    istringstream iss(line);
    A.resize(A.size() + 1);
    int a, j = 0;
    while (iss &gt;&gt; a) {
        A[i].push_back(a);
        j++;
    }
    i++;
}

i = 0;
while (getline(infile, line)) {
    istringstream iss(line);
    B.resize(B.size() + 1);
    int a;
    int j = 0;
    while (iss &gt;&gt; a) {
        B[i].push_back(a);
        j++;
    }
    i++;
}

infile.close();
ab.A = A;
ab.B = B;
return ab;
</code></pre>

<p>}</p>

<p>vector&lt; vector<int> > ijkalgorithm(vector&lt; vector<int> > A,
                                    vector&lt; vector<int> > B) {
    int n = A.size();</p>

<pre><code>// initialise C with 0s
vector&lt;int&gt; tmp(n, 0);
vector&lt; vector&lt;int&gt; &gt; C(n, tmp);

for (int i = 0; i &lt; n; i++) {
    for (int j = 0; j &lt; n; j++) {
        for (int k = 0; k &lt; n; k++) {
            C[i][j] += A[i][k] * B[k][j];
        }
    }
}
return C;
</code></pre>

<p>}</p>

<p>void printMatrix(vector&lt; vector<int> > matrix) {
    vector&lt; vector<int> >::iterator it;
    vector<int>::iterator inner;
    for (it=matrix.begin(); it != matrix.end(); it++) {
        for (inner = it->begin(); inner != it->end(); inner++) {
            cout &lt;&lt; *inner;
            if(inner+1 != it->end()) {
                cout &lt;&lt; "\t";
            }
        }
        cout &lt;&lt; endl;
    }
}</p>

<p>int main (int argc, char* argv[]) {
    string filename;
    if (argc &lt; 3) {
        filename = "2000.in";
    } else {
        filename = argv[2];
    }
    Result result = read (filename);
    vector&lt; vector<int> > C = ijkalgorithm(result.A, result.B);
    printMatrix(C);
    return 0;
}[/cpp]
[bash]real  1m40.439s
user    1m38.642s
sys 0m0.280s[/bash]</p>

<h3>ikj-algorithm</h3>


<p>Again, I've only switched line 61 and 62.</p>

<p>[bash]real  0m15.172s
user    0m14.877s
sys 0m0.248s[/bash]</p>

<h3>Library: Boost</h3>


<p>If you want to compile these scripts, you might have to install the boost libraries first. On Ubuntu you can enter:
[bash]sudo apt-get install libboost-math*[/bash]</p>

<p>[cpp]#include <sstream></p>

<h1>include <string></h1>

<h1>include <fstream></h1>

<h1>include <iostream></h1>

<h1>include <vector></h1>

<h1>include &lt;boost/numeric/ublas/matrix.hpp></h1>

<h1>include &lt;boost/numeric/ublas/io.hpp></h1>

<p>using namespace std;</p>

<p>struct Result {
    boost::numeric::ublas::matrix<int> A;
    boost::numeric::ublas::matrix<int> B;
};</p>

<p>int getMatrixSize(string filename) {
    string line;
    ifstream infile;
    infile.open (filename.c_str());
    getline(infile, line);
    return count(line.begin(), line.end(), '\t') + 1;
}</p>

<p>void printMatrix(boost::numeric::ublas::matrix<int> matrix) {
    for (unsigned int i=0; i &lt; matrix.size1(); i++) {
        for (unsigned int j=0; j &lt; matrix.size2(); j++) {
            cout &lt;&lt; matrix(i, j);
            if(j+1 != matrix.size2()) {
                cout &lt;&lt; "\t";
            } <br/>
        }
        cout &lt;&lt; endl;
    }
}</p>

<p>Result read(string filename) {
    Result ab;
    string line;
    ifstream infile;
    infile.open (filename.c_str());</p>

<pre><code>// get dimension
getline(infile, line);
int n = getMatrixSize(filename);

boost::numeric::ublas::matrix&lt;int&gt; A(n,n), B(n,n);

// process first line
istringstream iss(line);
int a, i = 0, j = 0;
while (iss &gt;&gt; a) {
    A(i,j) = a;
    j++;
}
i++;

while (getline(infile, line) &amp;amp;&amp;amp; !line.empty()) {
    istringstream iss(line);
    j = 0;
    while (iss &gt;&gt; a) {
        A(i,j) = a;
        j++;
    }
    i++;
}

i = 0;
while (getline(infile, line)) {
    istringstream iss(line);
    j = 0;
    while (iss &gt;&gt; a) {
        B(i,j) = a;
        j++;
    }
    i++;
}

infile.close();
ab.A = A;
ab.B = B;
return ab;
</code></pre>

<p>}</p>

<p>int main (int argc, char* argv[]) {
    string filename;
    if (argc &lt; 3) {
        filename = "2000.in";
    } else {
        filename = argv[2];
    }
    Result result = read (filename);</p>

<pre><code>boost::numeric::ublas::matrix&lt;int&gt; C;
C = boost::numeric::ublas::prod(result.A, result.B);
printMatrix(C);

return 0;
</code></pre>

<p>}[/cpp]</p>

<p>[bash]real  4m15.388s
user    4m10.272s
sys 0m0.588s[/bash]</p>

<h3>Library: Blitz</h3>


<p>This is a great example of useless library. I've installed the library:
[bash]sudo apt-get install libblitz*[/bash]
Then I wanted to use it. Well, I have no clue how I could exactly use it! See my StackOverflow Question: <a href="http://stackoverflow.com/questions/11113993/is-a-documentation-of-blitz-matrices-available">Is a documentation of Blitz++ matrices available?</a></p>

<h3>Conclusion for C++</h3>


<p>[caption id="attachment_28351" align="aligncenter" width="512"]<a href="http://martin-thoma.com/wp-content/uploads/2012/06/cpp-execution-time.png"><img src="http://martin-thoma.com/wp-content/uploads/2012/06/cpp-execution-time.png" alt="C++ execution times for matrix multiplication" title="C++ execution times for matrix multiplication" width="512" height="249" class="size-full wp-image-28351" /></a> C++ execution times for matrix multiplication[/caption]</p>

<p>Again, it brings a performance boost if you know how your CPU works. I was very astonished, that the library Boost is slower (actually MUCH slower) than my simplest approach was.</p>

<h2>Conclusion</h2>


<p>If I want to create a working piece of code in a minimum amount of time, I will always take Python. It has been very easy to solve this task with the given restrictions. But C++ is amazing when speed is important.</p>

<p>It was astonishingly difficult to find working code examples for this task for Java and C++. I was searching for libraries and found some, but the search results were not satisfying.</p>

<h2>See also</h2>


<ul>
  <li><a href="http://www.boost.org/doc/libs/1_49_0/libs/numeric/ublas/doc/matrix.htm">Boost Matrix multiplication</a></li>
  <li><a href="http://rosettacode.org/wiki/Matrix_multiplication">Rosetta Code: Matrix multiplication</a> (Implementations in 63 programming languages!)</li>
  <li><a href="http://stackoverflow.com/questions/10442365/why-is-matrix-multiplication-faster-with-numpy-than-with-ctypes-in-python">Why is matrix multiplication faster with numpy than with ctypes in Python?</a></li>
  <li><a href="http://stackoverflow.com/questions/11110604/why-is-boosts-matrix-multiplication-slower-than-mine">Why is boosts matrix multiplication slower than mine?</a></li>
</ul>




<div class="info">Continue reading with Part II: <a href="http://martin-thoma.com/strassen-algorithm-in-python-java-cpp/">The Strassen algorithm in Python, Java and C++</a></div>



<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
</div>

            <div class="footer">
    <div class="contact">
      <p>
        Martin<br />
        What You Are<br />
        you@example.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="https://github.com/yourusername">github.com/yourusername</a><br />
        <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
      </p>
    </div>
  </div>

        </div>
    </body>
</html>
