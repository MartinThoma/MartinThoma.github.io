<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Martin Thoma" />
        <meta name="copyright" content="Martin Thoma" />
        <link title = "Martin Thoma"
              type  = "application/opensearchdescription+xml"
              rel   = "search"
              href  = "../opensearch.xml">

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="SQL, ORM, SQLAlchemy, pypika, Query Builder, Code, " />

<meta property="og:title" content="Raw SQL vs Query Builder vs ORM "/>
<meta property="og:url" content="https://towardsdatascience.com/raw-sql-vs-query-builder-vs-orm-eee72dbdd275#cbe8-27a45e3740e8" />
<meta property="og:description" content="Screenshot of phpmyadmin Databases are the core of storing state for almost all web applications. For that reason taking care of the interactions with the database is crucial to make sure the application keeps running. The way to interact with most relational databases is SQL — the S*tructured Query …" />
<meta property="og:site_name" content="Martin Thoma" />
<meta property="og:article:author" content="Martin Thoma" />
<meta property="og:article:published_time" content="2020-05-17T20:00:00+02:00" />
<meta name="twitter:title" content="Raw SQL vs Query Builder vs ORM ">
<meta name="twitter:description" content="Screenshot of phpmyadmin Databases are the core of storing state for almost all web applications. For that reason taking care of the interactions with the database is crucial to make sure the application keeps running. The way to interact with most relational databases is SQL — the S*tructured Query …">
<meta property="og:image" content="logos/db.png" />
<meta name="twitter:image" content="logos/db.png" >

        <title>Raw SQL vs Query Builder vs ORM  · Martin Thoma
</title>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../static/print.css" media="print">
        <link rel="stylesheet" type="text/css" href="../static/custom.css" media="screen">

        <!-- MathJax -->
<script type="text/x-mathjax-config">
<!--
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [ ['$$', '$$'], ['\\[','\\]']],
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    processEscapes: true
  }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
// -->
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

        <link href="https://martin-thoma.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Martin Thoma - Full Atom Feed" />
        <link href="https://martin-thoma.com/feeds/index.xml" type="application/rss+xml" rel="alternate" title="Martin Thoma - Full RSS Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top navbar-default">
            <div class="container">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse">
                        <ul class="nav pull-left top-menu navbar-nav">
                            <li><a href=".." style="font-family: 'Monaco', 'Inconsolata', 'Andale Mono', 'Lucida Console', 'Bitstream Vera Sans Mono', 'Courier New', Courier, Monospace;
                        font-size: 20px;" class="navbar-brand" tabindex="-1">Martin Thoma</a>
                            </li>
                        </ul>
                        <ul class="nav pull-right top-menu navbar-nav">
                            <li ><a href="..">Home</a></li>
                            <li ><a href="../categories.html">Categories</a></li>
                            <li ><a href="../tags.html">Tags</a></li>
                            <li ><a href="../archives.html">Archives</a></li>
                            <li><a href="../support-me/">Support me</a></li>
                            <li><form class="navbar-form" action="../search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="search" class="search-query form-control" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-1 col-md-1"></div>
                <div class="col-sm-10 col-md-10">
<!-- article.html -->
<article>
<div class="row">
    <header class="page-header col-sm-10 col-md-10 col-md-offset-2">
    <h1><a href="https://towardsdatascience.com/raw-sql-vs-query-builder-vs-orm-eee72dbdd275#cbe8-27a45e3740e8">Raw SQL vs Query Builder vs ORM</a></h1>
    </header>
</div>

<div class="row">
    <div class="col-sm-2 col-md-2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div id="toc"><ul><li><a class="toc-href" href="#raw-sql" title="Raw SQL">Raw SQL</a><ul><li><a class="toc-href" href="#problem-1-sql-injections" title="Problem 1: SQL Injections">Problem 1: SQL Injections</a></li><li><a class="toc-href" href="#problem-2-typos-in-sql-commands" title="Problem 2: Typos in SQL Commands">Problem 2: Typos in SQL Commands</a></li><li><a class="toc-href" href="#problem-3-missing-editor-support" title="Problem 3: Missing Editor Support">Problem 3: Missing Editor Support</a></li><li><a class="toc-href" href="#problem-4-typos-in-table-or-column-names" title="Problem 4: Typos in Table or Column Names">Problem 4: Typos in Table or Column Names</a></li><li><a class="toc-href" href="#problem-5-change-management" title="Problem 5: Change management">Problem 5: Change management</a></li><li><a class="toc-href" href="#problem-6-query-extension" title="Problem 6: Query Extension">Problem 6: Query Extension</a></li></ul></li><li><a class="toc-href" href="#query-builder_1" title="Query Builder">Query Builder</a></li><li><a class="toc-href" href="#orm-object-relational-mapper" title="ORM: Object-Relational Mapper">ORM: Object-Relational Mapper</a><ul><li><a class="toc-href" href="#over-fetching-problem" title="Over-fetching Problem">Over-fetching Problem</a></li><li><a class="toc-href" href="#the-n1-problem-initial-under-fetching" title="The N+1 Problem: Initial Under-Fetching">The N+1 Problem: Initial Under-Fetching</a></li><li><a class="toc-href" href="#the-leaky-abstraction-problem" title="The Leaky Abstraction Problem">The Leaky Abstraction Problem</a></li></ul></li><li><a class="toc-href" href="#bonus-linq_1" title="Bonus: LINQ">Bonus: LINQ</a></li><li><a class="toc-href" href="#query-types-and-gradual-changes" title="Query Types and Gradual Changes">Query Types and Gradual Changes</a></li><li><a class="toc-href" href="#conclusion" title="Conclusion">Conclusion</a></li><li><a class="toc-href" href="#credits" title="Credits">Credits</a></li></ul></div>
        </nav>
    </div>
    <div class="col-sm-8 col-md-8 article-content" id="contentAfterTitle">

            
            <figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/relational-database.png"><img alt="Screenshot of phpmyadmin" src="../images/2020/07/relational-database.png" style="width: 512px;"/></a>
<figcaption class="text-center">Screenshot of phpmyadmin</figcaption>
</figure>
<p>Databases are the core of storing state for almost all web applications. For
that reason taking care of the interactions with the database is crucial to
make sure the application keeps running. The way to interact with most
relational databases is SQL &mdash; the <strong><em>S</em>*tructured </strong>Q<strong>uery </strong>L<strong>anguage<em>. SQL
makes it incredibly simple to switch the actual database system or the client
using that database. It&rsquo;s just SQL everywhere. You need a </em>database driver* and
then you can do the typical CRUD interactions: </strong>C<strong>reate, </strong>R<strong>ead, </strong>U<strong>pdate
and </strong>D**elete data.</p>
<p>After reading this article, you will know when to use raw SQL, a query builder
and an ORM. You will also know how to use each of them in Python.</p>
<p>All of the code in this article is runnable. You just need to <a href="https://gist.github.com/MartinThoma/95b603226f84f3be25f4eaf2393fba9e">initialize the database</a> and add environment variables. I use <a href="https://direnv.net/">direnv</a> to set environment variables:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># direnv needed; alternatively: "source .envrc"</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DB_USER</span><span class="o">=</span>root
<span class="nb">export</span><span class="w"> </span><span class="nv">DB_PASSWORD</span><span class="o">=</span>idontthinkso
</code></pre></div>
<h2 id="raw-sql"><strong>Raw SQL</strong></h2>
<p><em>Raw SQL, </em>sometimes also called <em>native SQL,</em> is the most basic, most
low-level form of database interaction. You tell the database what to do in the
language of the database. Most developers should know basics of SQL. This means
how to CREATE tables and views, how to SELECT and JOIN data, how to UPDATE and
DELETE data. For more complex things like <a href="https://en.wikipedia.org/wiki/Stored_procedure">stored
procedures</a>, T-SQL, PL-SQL,
in-depth knowledge about indices and their effect you will have a significantly
harder time to find knowledgeable people. SQL is far more powerful than many
developers think. I wouldn&rsquo;t know <a href="http://wiki.postgresql.org/wiki/Mandelbrot_set">how to create the Mandelbrot set with
SQL</a>, for example.</p>
<p>In order to illustrate the problems of raw SQL statements, take the example of a book portal. The users can see data about books, for example their title, original language and the author:</p>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/books-authors.png"><img alt="Every book has exactly one author, but every author might have an arbitrary number of books." src="../images/2020/07/books-authors.png" style="width: 512px;"/></a>
<figcaption class="text-center">Every book has exactly one author, but every author might have an arbitrary number of books.</figcaption>
</figure>
<p>For an author page, we are given the <code>authors.id</code> and want to see a list of
all <code>books.title</code> written by that author:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="c1"># You need to install the driver pymysql via &ldquo;pip install pymysql&rdquo;</span>
<span class="kn">import</span> <span class="nn">pymysql.cursors</span>


<span class="k">def</span> <span class="nf">db_connection</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Supply the decorated function with a database connection.</span>
<span class="sd">    Commit/rollback and close the connection after the function call.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">with_connection_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s2">"localhost"</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DB_USER"</span><span class="p">],</span>
            <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DB_PASSWORD"</span><span class="p">],</span>
            <span class="n">db</span><span class="o">=</span><span class="s2">"books"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">con</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">with_connection_</span>


<span class="nd">@db_connection</span>
<span class="k">def</span> <span class="nf">get_titles_by_author</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SELECT * FROM books WHERE author_id = %s"</span><span class="p">,</span> <span class="n">author_id</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">"title"</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">titles</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_titles_by_author</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<p>The decorator is utility code that the project might use a lot.</p>
<p>On the positive side, it is pretty clear what happens with raw SQL. You only need knowledge of Python and SQL. No need to be deep in third party software.</p>
<p>However, there are six negative aspects about using raw SQL to be aware of.</p>
<h3 id="problem-1-sql-injections">Problem 1: SQL Injections</h3>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/xkcd-327.png"><img alt="xkcd 327" src="../images/2020/07/xkcd-327.png" style="width: 512px;"/></a>
<figcaption class="text-center"><a href="https://xkcd.com/327/">xkcd 327</a></figcaption>
</figure>
<p>An SQL injection is an attack on services which have a placeholder in an SQL query which the attacker can fill in an unexpected way. For example:</p>
<div class="highlight"><pre><span></span><code><span class="n">sql</span> <span class="o">=</span> <span class="s2">"SELECT user_id FROM users WHERE name='</span><span class="si">{name}</span><span class="s2">' AND pw='</span><span class="si">{pw}</span><span class="s2">';"</span>
</code></pre></div>
<p>Given such an approach, the attacker could fill in ' OR name='admin' AND '1'='1 for the pw and empty for the name. This would result in the query</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">''</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">pw</span><span class="o">=</span><span class="s1">''</span>
<span class="k">OR</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">'admin'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">'1'</span><span class="o">=</span><span class="s1">'1'</span>
</code></pre></div>
<p>This will basically tell the application that the user signed in as admin.</p>
<p>Of course, escaping the quotes and not directly pasting in user input is what you should do. But developers make mistakes. Raw SQL queries make it easy to make this mistake.</p>
<h3 id="problem-2-typos-in-sql-commands">Problem 2: Typos in SQL Commands</h3>
<p>The first obvious problem of string-programming is that typos in the sub-language cannot be detected by the editor.</p>
<div class="highlight"><pre><span></span><code><span class="n">sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM books;"</span>
</code></pre></div>
<h3 id="problem-3-missing-editor-support">Problem 3: Missing Editor Support</h3>
<p>This problem is quite dumb, but still an open issue for many languages / editors: When developers write their SQL just in a string within their language, how should the editor know that this string needs to be parsed? How should the editor know that they want syntax highlighting and auto-completion?</p>
<p>You can see already in the example above that syntax highlighting is missing, but let me give you screenshots of well-known editors:</p>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/sublime-raw-sql.png"><img alt="Sublime Text 3.2" src="../images/2020/07/sublime-raw-sql.png" style="width: 512px;"/></a>
<figcaption class="text-center">Sublime Text 3.2</figcaption>
</figure>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/vs-code-1-47.png"><img alt="VS Code 1.47" src="../images/2020/07/vs-code-1-47.png" style="width: 512px;"/></a>
<figcaption class="text-center">VS Code 1.47</figcaption>
</figure>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/vim.png"><img alt="vim 8.1" src="../images/2020/07/vim.png" style="width: 512px;"/></a>
<figcaption class="text-center">vim 8.1</figcaption>
</figure>
<p>In contrast, here is the same query in an query.sql file:</p>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/sublime-query.png"><img alt="Sublime Text 3.2" src="../images/2020/07/sublime-query.png" style="width: 512px;"/></a>
<figcaption class="text-center">Sublime Text 3.2</figcaption>
</figure>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/vs-code-query.png"><img alt="VS Code 1.47" src="../images/2020/07/vs-code-query.png" style="width: 512px;"/></a>
<figcaption class="text-center">VS Code 1.47</figcaption>
</figure>
<figure class="wp-caption aligncenter img-thumbnail">
<a href="../images/2020/07/vim-query.png"><img alt="vim 8.1" src="../images/2020/07/vim-query.png" style="width: 512px;"/></a>
<figcaption class="text-center">vim 8.1</figcaption>
</figure>
<p>I&rsquo;ve tried PyCharm as well. Besides having another color for strings, it looks
the same. It does not recognize that the string contains SQL.</p>
<p>If you really need raw queries and if you still want syntax highlighting, you
can put each query in its own query.sql file. This way the editor knows to use
SQL syntax highlighting.</p>
<h3 id="problem-4-typos-in-table-or-column-names">Problem 4: Typos in Table or Column Names</h3>
<div class="highlight"><pre><span></span><code><span class="n">sql</span> <span class="o">=</span> <span class="s2">"SELECT * from boks;"</span>
</code></pre></div>
<p>This group of errors is way harder to find. Now the checking code does not only
have to know how SQL works, it also has to know your data. The database schema
to be more precise.</p>
<h3 id="problem-5-change-management">Problem 5: Change management</h3>
<p>Databases change over time. With raw SQL, you typically don&rsquo;t get any support
for that. You have to migrate the schema and all queries yourself.</p>
<h3 id="problem-6-query-extension">Problem 6: Query Extension</h3>
<p>If you have an analytical query, it is nice if you can apply slight
modifications to it. For example, imagine tracking data where you want to know
how many users clicked on a button. You might have a &ldquo;base query&rdquo; for that.
Depending on the use case you might want to filter for a certain time frame or
characteristics of the user. It&rsquo;s possible to extend a query when you have raw
SQL, but it&rsquo;s cumbersome. You need to touch the original query and add
placeholders.</p>
<h2 id="query-builder_1"><strong>Query Builder</strong></h2>
<p>Libraries which are written in the programming language you use and use native
classes and functions to build SQL queries are called <em>query builders</em>. Query
builders typically have a <a href="https://en.wikipedia.org/wiki/Fluent_interface">fluent
interface</a>. This means, that
the queries are built by an object-oriented interface which uses method
chaining:</p>
<div class="highlight"><pre><span></span><code><span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">books</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">author_id</span> <span class="o">==</span> <span class="n">aid</span><span class="p">)</span>
</code></pre></div>
<p>There are also graphical tools which are sometimes also called query builders,
but for this article I don&rsquo;t mean them.</p>
<p>JavaScript <a href="http://knexjs.org/">Knex</a>, PHP has
<a href="https://www.doctrine-project.org/projects/doctrine-dbal/en/2.10/reference/query-builder.html#sql-query-builder">Doctrine</a>,
Java has <a href="http://www.querydsl.com/">QueryDSL</a> and <a href="http://www.jooq.org/">JOOQ</a>.</p>
<p><a href="https://github.com/kayak/pypika">Pypika</a> is an example for a Query Builder in
Python. The example query from above can be built and executed like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Core Library modules</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="c1"># Third party modules</span>
<span class="kn">import</span> <span class="nn">pymysql.cursors</span>
<span class="kn">from</span> <span class="nn">pypika</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Table</span>

<span class="c1"># First party modules</span>
<span class="kn">from</span> <span class="nn">raw_sql</span> <span class="kn">import</span> <span class="n">db_connection</span>


<span class="nd">@db_connection</span>
<span class="k">def</span> <span class="nf">get_titles_by_author</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">books</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">author_id</span> <span class="o">==</span> <span class="n">author_id</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_sql</span><span class="p">(</span><span class="n">quote_char</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">"title"</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">titles</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_titles_by_author</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<p>Note that the resulting query is still the same as in the raw code. It was just built in another way. This means the database performance is still the same. And query building is not a complex task, so the application performance overall should stay the same.</p>
<p>You can also see that the connection handling is still done as before. The
total lines of code increased by 3 lines compared to the raw SQL example.
However, the query is easier to extend and reuse. For example, you could
imagine that you have a set of complex joins and a lot of WHERE statements.
With a normal SQL query, you will start to add options there. With a query
builder, it is simpler to extend and reuse queries. To make it reusable you
would expose the query&nbsp;<code>q</code> somewhere.</p>
<p>The query builder prevents typos in the offered parts &mdash; <code>.select</code>, <code>.from_</code>,
<code>.where</code> in the example above. It does not help with column names, as they are
still only strings. In other words: A query builder solves problem&nbsp;1 and&nbsp;2,
addresses problem&nbsp;3, and still has problem&nbsp;4 and&nbsp;5.</p>
<h2 id="orm-object-relational-mapper"><strong>ORM: Object-Relational Mapper</strong></h2>
<p>ORMs create an object for each database table. This way, there is a language-native representation and thus all of the languages ecosystem features such as autocomplete and syntax-highlighting work.</p>
<p>ORMs are extremely popular in many languages: Java has <a href="http://hibernate.org/">Hibernate</a>, PHP has <a href="https://laravel.com/docs/5.0/eloquent">Eloquent</a>, Ruby has <a href="https://guides.rubyonrails.org/active_record_basics.html">activerecord</a>, JavaScript has <a href="https://sequelize.org/">Sequelize</a> and <a href="https://typeorm.io/">TypeORM</a>, and Python has <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>.</p>
<p>Here is how the book example looks with SQLAlchemy:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Core Library modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="c1"># Third party modules</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">db_connection</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Supply the decorated function with a database connection.</span>
<span class="sd">    Commit/rollback and close the connection after the function call.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">with_connection_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># https://martin-thoma.com/sql-connection-strings/</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DB_USER"</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DB_PASSWORD"</span><span class="p">]</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s2">"mysql+pymysql://</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">@localhost/books"</span><span class="p">)</span>
        <span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">with_connection_</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"books"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">author_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="nd">@db_connection</span>
<span class="k">def</span> <span class="nf">get_titles_by_author</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">author_id</span> <span class="o">==</span> <span class="n">author_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_titles_by_author</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<p>A cool point about ORMs is that they sometimes help with changes. In Python, there is <a href="https://alembic.sqlalchemy.org/en/latest/">Alembic</a> which can automatically detect when your models changed compared to the last known state of the database. Alembic can then create schema migration files for you. They look like that:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">op</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">mysql</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s2">"1cdeb9f52797"</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s2">"057fccb0279d"</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"users"</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">"confirmed_on"</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"users"</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">"registered_on"</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
        <span class="s2">"users"</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="s2">"status"</span><span class="p">,</span>
            <span class="n">sa</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">"email_confirmation_missing"</span><span class="p">,</span> <span class="s2">"active"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"userstatus"</span><span class="p">),</span>
            <span class="n">server_default</span><span class="o">=</span><span class="s2">"email_confirmation_missing"</span><span class="p">,</span>
            <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s2">"users"</span><span class="p">,</span> <span class="s2">"email_confirmed_at"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
        <span class="s2">"users"</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">"email_confirmed_at"</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">DATETIME</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s2">"users"</span><span class="p">,</span> <span class="s2">"status"</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s2">"users"</span><span class="p">,</span> <span class="s2">"registered_on"</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s2">"users"</span><span class="p">,</span> <span class="s2">"confirmed_on"</span><span class="p">)</span>
</code></pre></div>
<p>It requires initial effort to represent the database within the code so that there are objects which represent the tables of the database. After that initial effort you need to make sure that the database is in sync with the query builders code base. What you get from that effort is faster development when you just need to write new queries. As you can also get syntax highlighting and auto-formatting, it could also reduce maintenance by making the queries easier to read.</p>
<h3 id="over-fetching-problem">Over-fetching Problem</h3>
<p>When you fire Queries with ORMs, you tend to get more than you need. For example, if you wanted to use the ORM directly for the book query from above, you would define the foreign key like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Core Library modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="c1"># Third party modules</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="c1"># First party modules</span>
<span class="kn">from</span> <span class="nn">orms</span> <span class="kn">import</span> <span class="n">db_connection</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"authors"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"books"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">author_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">"authors.id"</span><span class="p">))</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Author"</span><span class="p">)</span>


<span class="nd">@db_connection</span>
<span class="k">def</span> <span class="nf">get_titles_by_author</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">author_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">books</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_titles_by_author</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<p>Then the database receives those two queries:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">authors</span><span class="p">.</span><span class="n">id</span><span class="w">         </span><span class="k">AS</span><span class="w"> </span><span class="n">authors_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">authors</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">authors_first_name</span><span class="p">,</span>
<span class="w">       </span><span class="n">authors</span><span class="p">.</span><span class="n">last_name</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">authors_last_name</span>
<span class="k">FROM</span><span class="w">   </span><span class="n">authors</span>
<span class="k">WHERE</span><span class="w">  </span><span class="n">authors</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">books</span><span class="p">.</span><span class="n">id</span><span class="w">        </span><span class="k">AS</span><span class="w"> </span><span class="n">books_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">books</span><span class="p">.</span><span class="n">title</span><span class="w">     </span><span class="k">AS</span><span class="w"> </span><span class="n">books_title</span><span class="p">,</span>
<span class="w">       </span><span class="n">books</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">books_author_id</span>
<span class="k">FROM</span><span class="w">   </span><span class="n">books</span>
<span class="k">WHERE</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">books</span><span class="p">.</span><span class="n">author_id</span>
</code></pre></div>
<p>This is inefficient for multiple reasons:</p>
<ol>
<li>I didn&rsquo;t want author information at all.</li>
<li>The database needs to execute two queries instead of one.</li>
<li>I didn&rsquo;t want the books ID or the authors ID. Of course, this is a tiny
   example where it doesn&rsquo;t matter. But imagine your query would return several
   hundred rows and have also sever hundred columns. And maybe some would be
   filled with rather big content, e.g. a
   <a href="https://mariadb.com/kb/en/longblob/">LONGBLOB</a>.</li>
</ol>
<p>Of course, you can do something like that:</p>
<iframe frameborder="0" src="https://medium.com/media/799d89eead2c1d176e7343222a071c3b"></iframe>
<p>which results in this query:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">authors</span><span class="p">.</span><span class="n">id</span><span class="w">         </span><span class="k">AS</span><span class="w"> </span><span class="n">authors_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">authors</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">authors_first_name</span><span class="p">,</span>
<span class="w">       </span><span class="n">authors</span><span class="p">.</span><span class="n">last_name</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">authors_last_name</span><span class="p">,</span>
<span class="w">       </span><span class="n">books_1</span><span class="p">.</span><span class="n">id</span><span class="w">         </span><span class="k">AS</span><span class="w"> </span><span class="n">books_1_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">books_1</span><span class="p">.</span><span class="n">title</span><span class="w">      </span><span class="k">AS</span><span class="w"> </span><span class="n">books_1_title</span>
<span class="k">FROM</span><span class="w">   </span><span class="n">authors</span>
<span class="w">       </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">books</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">books_1</span>
<span class="w">                    </span><span class="k">ON</span><span class="w"> </span><span class="n">authors</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">books_1</span><span class="p">.</span><span class="n">author_id</span>
<span class="k">WHERE</span><span class="w">  </span><span class="n">authors</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>Now this is even worse. I first made this as a mistake, but I think this shows perfectly how you can get the right result but in a very complex way when using an ORM. The correct way, of course, would be:</p>
<iframe frameborder="0" src="https://medium.com/media/be65663477c66d9b44c0cfd8e329c327"></iframe>
<p>Which results in this query:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">books</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">books_title</span>
<span class="k">FROM</span><span class="w">   </span><span class="n">books</span><span class="p">,</span>
<span class="w">       </span><span class="n">authors</span>
<span class="k">WHERE</span><span class="w">  </span><span class="n">authors</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>The point of this example is not that ORMs make it hard to do the right thing.
The last example is certainly easy to understand. But they also make it easy to
create queries which are wrong in a subtle way. Imagine you received the
orms2.py or orms3.py example to review. They do the right thing, the unit tests
are not terrible slow either. Would you be certain to spot the unnecessary
complexity? Also when the desired query gets way more complex?</p>
<p>For raw SQL and query builders, you have to go out of your way to come up with
similar complex queries. There it is hard to write a too complex query and it&rsquo;s
easy to spot them.</p>
<h3 id="the-n1-problem-initial-under-fetching">The N+1 Problem: Initial Under-Fetching</h3>
<p>Imagine you want to print a list of all books with the author names. In raw
SQL, you would execute this query:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">       </span><span class="n">b</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
<span class="w">       </span><span class="n">a</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span>
<span class="w">       </span><span class="n">a</span><span class="p">.</span><span class="n">last_name</span>
<span class="k">FROM</span><span class="w">   </span><span class="n">books</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span>
<span class="w">       </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span>
<span class="w">              </span><span class="k">ON</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span>
</code></pre></div>
<p>With an ORM, you might be tempted to do this:</p>
<iframe frameborder="0" src="https://medium.com/media/b7b584fc3628ded28094f054aa6d5da4"></iframe>
<p>It looks fine because you don&rsquo;t see a session.query in the for-loop, but for
every element in there it fires one query. So if you have received n books in
the first query, you will execute n queries you&rsquo;re potentially not aware of.
You have n+1 queries instead of 1 .</p>
<h3 id="the-leaky-abstraction-problem">The Leaky Abstraction Problem</h3>
<p>Abstraction is a two-sided coin: On the one hand, it simplifies things. The
developer does not have to deal with the details of the database interaction
and query building. On the other hand, developers are not aware of what they
actually query from the database or how many queries they send. For this
reason, some interactions are more inefficient than they need to be
(<a href="https://www.youtube.com/watch?v=3TJfR1Ta4GU">example</a>). The ORM might not
know that just in the next line of code a very similar query is fired which
could be combined with the first one. For example, imagine that you have a book
portal where people can give a list of authors and you return them the list of
all books written by those. You might be tempted to do something like this:</p>
<iframe frameborder="0" src="https://medium.com/media/ab03bbf6e4c362fa609cd34e424c2bbf"></iframe>
<p>Now you send a query once for each author. Of course, you can do that in a
single query. And you should, because although the loop above does not seem to
bad, you have a network connection in between. This is how you do it with a
single query:</p>
<iframe frameborder="0" src="https://medium.com/media/3cd1bcc951866f18156a587f43f5bac4"></iframe>
<h2 id="bonus-linq_1">Bonus: LINQ</h2>
<p>Language Integrated Queries (short: LINQ) are available in C# and might be a built-in solution for the problems query builders try to solve. Here is an <a href="https://en.wikipedia.org/wiki/Language_Integrated_Query#Language_extensions">example from Wikipedia</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">var</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">from</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">SomeCollection</span>
<span class="w">               </span><span class="n">where</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">SomeProperty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span>
<span class="w">               </span><span class="n">select</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">SomeProperty</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">OtherProperty</span><span class="p">};</span>
</code></pre></div>
<p>That&rsquo;s extremely neat, isn&rsquo;t it?</p>
<h2 id="query-types-and-gradual-changes">Query Types and Gradual Changes</h2>
<p>I&rsquo;ve used a very simple example query. Of course, queries can become way more
complicated. I have written myself queries which have several hundred lines.
There are two groups of workloads which are typically distinguished:
<a href="https://en.wikipedia.org/wiki/Online_transaction_processing">OLTP</a> and
<a href="https://en.wikipedia.org/wiki/Online_analytical_processing">OLAP</a>. OLTP
workloads have a big amount of small inserts / updates / deletes, whereas OLAP
workloads run a small amount of complex select queries for analysis.</p>
<p>Of course, if you are in a scenario where most of your queries are rather
simple, it is easy to switch to a query builder or an ORM. But if you have
complex queries the switch to an ORM might even be impossible.</p>
<p>This is where gradual changes come into play. Similar as
<a href="https://medium.com/analytics-vidhya/type-annotations-in-python-3-8-3b401384403d">Python supports gradual typing</a>,
some ORMs / Query Builders allow you to use raw SQL. And some query builders
allow you to first use strings for the table and column names and transition as
you like to objects. If you can just take the amount of abstraction that feels
natural, your development speed is not hindered. If you have a complex query
which you first want to get right, just write it raw. Changing it to an
expression by a query builder later is still possible.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Raw SQL is for sure the most powerful way to interact with your database as it
is the databases native language. The drawback is that you might use features
which are specific to that database, which makes a future database switch
harder. Another drawback is that core editor features like syntax highlighting
and autocompletion are missing. Extending queries is cumbersome and the risk of
SQL injections is higher.</p>
<p>Query Builders add little development overhead and no relevant runtime overhead
compared to raw SQL and prevent typos in the SQL keywords. They make extending
queries easier and make SQL injections harder.</p>
<p>ORMs provide the highest form of abstraction and prevent typos not only in SQL
keywords, but also in the table and column names. They take longer to get
started than query builders &mdash; both, from a learning curve perspective and from
the perspective of initial development overhead. As they abstract away a lot,
there is a higher risk to execute expensive queries or too many queries.</p>
<h2 id="credits">Credits</h2>
<p>A huge thank you to <a href="https://www.linkedin.com/in/marcel-kost/">Marcel Kost</a> and
<a href="https://www.linkedin.com/in/adrian-vogelsgesang-95485a7a/?originalSubdomain=de">Adrian
Vogelsgesang</a>
who pointed out many interesting aspects for this article. They build the Hyper
Database that is used inside Tableau, so they are the experts when it comes to
complicated queries and how the database systems deal with those. Thank you 🤗</p>
            
            <div id="disqus_thread" class="no-print"></div>
<script>
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');

        s.src = '//martinthoma.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

            <hr/>
        </div>
        <section>
        <div class="col-sm-2 col-md-2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2020-05-17T20:00:00+02:00">Mai 17, 2020</time>
            <br/>
            by <a rel="author" class="vcard author post-author" itemprop="author" href="../author/martin-thoma/"><span class="fn" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name">Martin Thoma</span></span></a>
            <h4>Category</h4>
            <a class="category-link" href="../categories.html#code-ref">Code</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="../tags.html#orm-ref">ORM
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#pypika-ref">pypika
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#query-builder-ref">Query Builder
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#sql-ref">SQL
                    <span>4</span>
</a></li>
                <li><a href="../tags.html#sqlalchemy-ref">SQLAlchemy
                    <span>2</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="https://twitter.com/_martinthoma" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="mailto:info@martin-thoma.de" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
    <a href="https://github.com/MartinThoma" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://stackoverflow.com/users/562769/martin-thoma" title="My Stackoverflow Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-stackoverflow sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="col-sm-1 col-md-1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer class="no-print">
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-subtitle"><span class="site-name">Martin Thoma</span> - A blog about Code, the Web and Cyberculture</li>
        <li><a href="https://martin-thoma.com/email-subscription">E-mail subscription</a></li>
        <li><a href="https://martin-thoma.com/feeds/index.xml">RSS-Feed</a></li>
        <li><a href="http://www.martin-thoma.de/privacy.htm">Privacy/Datenschutzerkl&auml;rung</a></li>
        <li><a href="http://www.martin-thoma.de/impressum.htm">Impressum</a></li>
        <li class="elegant-power">Powered by
            <a href="https://blog.getpelican.com/" title="Pelican Home Page" tabindex="-1">Pelican</a>.
            Theme: <a href="https://elegant.oncrashreboot.com" title="Theme Elegant Home Page" tabindex="-1">Elegant</a>
            by <a href="https://www.oncrashreboot.com/" title="Talha Mansoor Home Page" tabindex="-1">Talha Mansoor</a></li>
    </ul>
</div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
        <script>
(function(){
    'use strict';

    /*
    Create intra-page links
    Requires that your headings already have an `id` attribute set
    For every heading in your page, this adds a little anchor link `#` that you can click to get a permalink to the heading.
    Ignores `h1`, because you should only have one per page.
    The text content of the tag is used to generate the link, so it will fail "gracefully-ish" if you have duplicate heading text.

    Credit: https://gist.github.com/SimplGy/a229d25cdb19d7f21231
     */

    var headingNodes = [], results, link,
        tags = ['h2', 'h3', 'h4', 'h5', 'h6'];

    tags.forEach(function(tag){
        var contentTag = document.getElementById('contentAfterTitle');
      results = contentTag.getElementsByTagName(tag);
      Array.prototype.push.apply(headingNodes, results);
    });

    headingNodes.forEach(function(node){
      link = document.createElement('a');
      link.className = 'deepLink';
      link.textContent = ' ¶';
      link.href = '#' + node.getAttribute('id');
      node.appendChild(link);
    });

  })();
</script>
    </body>
    <!-- Theme: Elegant built for Pelican
    License : https://elegant.oncrashreboot.com -->
</html>