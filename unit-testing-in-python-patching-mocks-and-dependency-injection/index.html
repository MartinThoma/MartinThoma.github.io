<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Martin Thoma" />
        <meta name="copyright" content="Martin Thoma" />
        <link title = "Martin Thoma"
              type  = "application/opensearchdescription+xml"
              rel   = "search"
              href  = "../opensearch.xml">

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Python, Unit Testing, pytest, patching, Mock, dependency-injection, Code, " />

<meta property="og:title" content="Unit Testing in Python — Patching, Mocks and Dependency Injection "/>
<meta property="og:url" content="https://levelup.gitconnected.com/unit-testing-in-python-mocking-patching-and-dependency-injection-301280db2fed" />
<meta property="og:description" content="Unit Testing in general is trivial with Python and pytest, but a lot of developers get frustrated when they have to patch dependencies away to make code testable. In this article, you will learn how to patch and create mocks. If you want to refresh basics about unit testing in …" />
<meta property="og:site_name" content="Martin Thoma" />
<meta property="og:article:author" content="Martin Thoma" />
<meta property="og:article:published_time" content="2020-07-09T17:00:00+02:00" />
<meta name="twitter:title" content="Unit Testing in Python — Patching, Mocks and Dependency Injection ">
<meta name="twitter:description" content="Unit Testing in general is trivial with Python and pytest, but a lot of developers get frustrated when they have to patch dependencies away to make code testable. In this article, you will learn how to patch and create mocks. If you want to refresh basics about unit testing in …">
<meta property="og:image" content="logos/python.png" />
<meta name="twitter:image" content="logos/python.png" >

        <title>Unit Testing in Python — Patching, Mocks and Dependency Injection  · Martin Thoma
</title>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../static/print.css" media="print">
        <link rel="stylesheet" type="text/css" href="../static/custom.css" media="screen">

        <!-- MathJax -->
<script type="text/x-mathjax-config">
<!--
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [ ['$$', '$$'], ['\\[','\\]']],
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    processEscapes: true
  }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
// -->
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

        <link href="https://martin-thoma.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Martin Thoma - Full Atom Feed" />
        <link href="https://martin-thoma.com/feeds/index.xml" type="application/rss+xml" rel="alternate" title="Martin Thoma - Full RSS Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top navbar-default">
            <div class="container">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse">
                        <ul class="nav pull-left top-menu navbar-nav">
                            <li><a href=".." style="font-family: 'Monaco', 'Inconsolata', 'Andale Mono', 'Lucida Console', 'Bitstream Vera Sans Mono', 'Courier New', Courier, Monospace;
                        font-size: 20px;" class="navbar-brand" tabindex="-1">Martin Thoma</a>
                            </li>
                        </ul>
                        <ul class="nav pull-right top-menu navbar-nav">
                            <li ><a href="..">Home</a></li>
                            <li ><a href="../categories.html">Categories</a></li>
                            <li ><a href="../tags.html">Tags</a></li>
                            <li ><a href="../archives.html">Archives</a></li>
                            <li><a href="../support-me/">Support me</a></li>
                            <li><form class="navbar-form" action="../search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="search" class="search-query form-control" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-1 col-md-1"></div>
                <div class="col-sm-10 col-md-10">
<article>
<div class="row">
    <header class="page-header col-sm-10 col-md-10 col-md-offset-2">
    <h1><a href="https://levelup.gitconnected.com/unit-testing-in-python-mocking-patching-and-dependency-injection-301280db2fed"> Unit Testing in Python — Patching, Mocks and Dependency Injection  </a></h1>
    </header>
</div>

<div class="row">
    <div class="col-sm-2 col-md-2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div id="toc"><ul><li><a class="toc-href" href="#the-abstract-pattern-of-the-problem" title="The Abstract Pattern of the Problem">The Abstract Pattern of the Problem</a></li><li><a class="toc-href" href="#the-problem-simple-examples" title="The Problem &mdash; Simple Examples">The Problem &mdash; Simple Examples</a></li><li><a class="toc-href" href="#examples-for-external-dependencies" title="Examples for External Dependencies">Examples for External Dependencies</a></li><li><a class="toc-href" href="#the-solution-patching" title="The solution: Patching!">The solution: Patching!</a></li><li><a class="toc-href" href="#direct-replacement-dont-do-this" title="Direct replacement: Don&rsquo;t do this!">Direct replacement: Don&rsquo;t do this!</a></li><li><a class="toc-href" href="#mock-and-magicmock" title="Mock and MagicMock">Mock and MagicMock</a></li><li><a class="toc-href" href="#spec-autospec-spec_set" title="spec, autospec &amp; spec_set">spec, autospec &amp; spec_set</a></li><li><a class="toc-href" href="#pytests-monkeypatch" title="pytests monkeypatch">pytests monkeypatch</a></li><li><a class="toc-href" href="#external-packages" title="External Packages">External Packages</a></li><li><a class="toc-href" href="#dependency-injection" title="Dependency Injection">Dependency Injection</a></li><li><a class="toc-href" href="#temporary-files-are-mocks-a-code-smell" title="Temporary files: Are Mocks a Code Smell?">Temporary files: Are Mocks a Code Smell?</a></li><li><a class="toc-href" href="#dependency-injection-randomness" title="Dependency Injection: Randomness">Dependency Injection: Randomness</a></li><li><a class="toc-href" href="#terminology" title="Terminology">Terminology</a></li><li><a class="toc-href" href="#a-note-about-architecture" title="A note about Architecture">A note about Architecture</a></li><li><a class="toc-href" href="#what-else-is-there" title="What else is there?">What else is there?</a></li><li><a class="toc-href" href="#whats-next" title="What&rsquo;s next?">What&rsquo;s next?</a></li></ul></div>
        </nav>
    </div>
    <div class="col-sm-8 col-md-8 article-content" id="contentAfterTitle">

            
            <p>Unit Testing in general is trivial with Python and pytest, but a lot of
developers get frustrated when they have to patch dependencies away to make
code testable. In this article, you will learn how to patch and create mocks.
If you want to refresh basics about unit testing in Python first, have a look
at the first part of this series: <a href="https://medium.com/swlh/unit-testing-in-python-basics-21a9a57418a0#0e28">Unit Testing in Python &mdash; The Basics</a>.</p>
<h2 id="the-abstract-pattern-of-the-problem">The Abstract Pattern of the Problem</h2>
<p>A dependency of the function we want to test can have an effect in three different ways: By side-effects, return values or exceptions.</p>
<p>Problem 1: A dependencies side-effect</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">a_function</span><span class="p">():</span>
    <span class="o">...</span>  <span class="c1"># Application code to be tested</span>
    <span class="n">a_dependency</span><span class="p">()</span>
    <span class="o">...</span>  <span class="c1"># Application code to be tested</span>
</code></pre></div>
<p>Problem 2: A dependencies return value</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">a_function</span><span class="p">():</span>
    <span class="o">...</span>  <span class="c1"># Application code to be tested</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">a_dependency</span><span class="p">()</span>
    <span class="o">...</span>  <span class="c1"># Application code to be tested; it might use foo</span>
</code></pre></div>
<p>Problem 3: A dependency throws an Exception</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">a_function</span><span class="p">():</span>
    <span class="o">...</span>  <span class="c1"># Application code to be tested</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">a_dependency</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># Application code to be tested</span>
        <span class="o">...</span>  <span class="c1"># this might depend on the type of Exception</span>
    <span class="o">...</span>  <span class="c1"># Application code to be tested</span>
</code></pre></div>
<h2 id="the-problem-simple-examples">The Problem &mdash; Simple Examples</h2>
<p>Most examples in the wild are way more complex and usually they also need some
refactoring to make the code easier to maintain. So I created three examples
which are a bit closer to real applications while still keeping the bloat of
real applications away.</p>
<p>Example 1: We want to add a user to a database. You can see that db does not
return anything, but we change the state of our system. And we want to be sure
that we don&rsquo;t actually change our production system when the unit tests are
running!</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">bcrypt</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">insert_user_into_db</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>Example 2: Generate a file name based on the current date. You can see that the dependency datetime returns a value:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">def</span> <span class="nf">generate_filename</span><span class="p">():</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2">.png"</span>
</code></pre></div>
<p>Similarly, you could imagine a function which returns the weather in an English sentence and uses an API to get the actual weather (<a href="https://gist.github.com/MartinThoma/5c7224ceae47e74645e0145d26dc03ec">example</a>).</p>
<p>Example 3: In my project <a href="https://github.com/MartinThoma/edapy">edapy</a> I looked at metadata from PDF files. I use the dependency PdfFileReader and have the file itself as an dependency. As the PDF file could be broken, PyPDF2 might throw an exception. So you can imagine code like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">PyPDF2.utils</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="kn">import</span> <span class="n">PdfFileReader</span>


<span class="k">def</span> <span class="nf">get_pdf_info</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pdf_toread</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PyPDF2</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">PdfReadError</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">"is_errornous"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="c1"># a lot more</span>
    <span class="k">return</span> <span class="n">info</span>
</code></pre></div>
<p>When you want to test such functions, you have the problem that the expected output is not only dependent on the function itself, but also on something external. In the cases above, the system time, an external service, and the file system.</p>
<h2 id="examples-for-external-dependencies">Examples for External Dependencies</h2>
<p>There are lots of external dependencies your tests might have:</p>
<ul>
<li>Date or time</li>
<li>Internet: A web service you need to use</li>
<li>File System: A file you need to create / read / edit / delete</li>
<li>Database: Data you select / insert / update/ delete</li>
<li>Randomness: Your code might make use of random or np.random</li>
</ul>
<p>Just like the example above, they make isolated unit testing hard or even impossible.</p>
<h2 id="the-solution-patching">The solution: Patching!</h2>
<p>The overall strategy to test this is always the same: Replace the external dependency that is causing headaches by something in your control. The act of replacing the dependency is called <strong><em>patching</em></strong>, the replacement is called a <strong><em>mock</em></strong>. Depending on what exactly the mock does, you might also hear this being called a Test Double, Test Stub, Test Spy or a Fake Object. In practice in Python, the distinction does not matter. If you&rsquo;re interested, I recommend <a href="https://martinfowler.com/articles/mocksArentStubs.html#TheDifferenceBetweenMocksAndStubs#TheDifferenceBetweenMocksAndStubs">Martin Fowler: The Difference Between Mocks and Stubs</a>. I will call all of them just mocks.</p>
<p>Let&rsquo;s make a tiny example how to use patch!</p>
<p><code>fraud_example.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">external_dependency</span> <span class="kn">import</span> <span class="n">dark_magic</span>


<span class="k">def</span> <span class="nf">is_credit_card_fraud</span><span class="p">(</span><span class="n">transaction</span><span class="p">):</span>
    <span class="n">fraud_probability</span> <span class="o">=</span> <span class="n">dark_magic</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fraud_probability</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<p><code>external_dependency.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">dark_magic</span><span class="p">(</span><span class="n">transaction</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
</code></pre></div>
<p>No matter which transaction you would use, the function is_credit_card_fraud would throw a ValueError.</p>
<p>This is how you patch that dependency away with a decorator <code>@patch</code>:</p>
<p><code>test_fraud_example.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>


<span class="k">def</span> <span class="nf">the_mock</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.999</span>


<span class="nd">@patch</span><span class="p">(</span><span class="s2">"fraud_example.dark_magic"</span><span class="p">,</span> <span class="n">the_mock</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_credit_card_fraud</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">fraud_example</span>

    <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"amount_usd"</span><span class="p">:</span> <span class="s2">"9999.99"</span><span class="p">,</span> <span class="s2">"overnight_shipping"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">is_fraud</span> <span class="o">=</span> <span class="n">fraud_example</span><span class="o">.</span><span class="n">is_credit_card_fraud</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_fraud</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>
<p>And this is how you patch the dependency fraud_example.dark_magic away with a context handler ( with ... ):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_is_credit_card_fraud_context_handler</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">fraud_example</span>

    <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"amount_usd"</span><span class="p">:</span> <span class="s2">"9999.99"</span><span class="p">,</span> <span class="s2">"overnight_shipping"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">"fraud_example.dark_magic"</span><span class="p">,</span> <span class="n">the_mock</span><span class="p">):</span>
        <span class="n">is_fraud</span> <span class="o">=</span> <span class="n">fraud_example</span><span class="o">.</span><span class="n">is_credit_card_fraud</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_fraud</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>
<p>When you now execute pytest , the test will succeed. You will always get 0.999 as a return value of dark_magic 🎉</p>
<p>A part that might be surprising in this example is the first parameter of the patch decorator: It&rsquo;s "fraud_example.dark_magic" and NOT "external_dependency.dark_magic" ! The target of your replacement is always what was loaded within the file you want to test, not where it was loaded from. Lisa Roach has pointed this out elegantly in her talk <a href="https://www.youtube.com/watch?v=ww1UsGZV8fQ">Demystifying the Patch Function</a>.</p>
<h2 id="direct-replacement-dont-do-this">Direct replacement: Don&rsquo;t do this!</h2>
<p>The following is an example which does not use patch and seems to work, but it has a big flaw. If you directly replace datetime.datetime instead of patching it, it will be overwritten in all other contexts after that as well! ⚠️</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Core Library modules</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="c1"># First party modules</span>
<span class="kn">from</span> <span class="nn">mock_example</span> <span class="kn">import</span> <span class="n">generate_filename</span>


<span class="k">class</span> <span class="nc">NewDate</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_generate_filename</span><span class="p">():</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">NewDate</span>
    <span class="k">assert</span> <span class="n">generate_filename</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"1990-04-28.png"</span>
</code></pre></div>
<h2 id="mock-and-magicmock">Mock and MagicMock</h2>
<p>You now know how to replace a dependency, hence it is time to talk about what to replace it with. This is where unittest.mock.Mock and unittest.mock.MagicMock come into play.</p>
<p>Everything you do with Mock will return a Mock. Call a function? Get a Mock as a return value. Access an attribute? Get a Mock as a value.</p>
<p>Python has so called &ldquo;magic&rdquo; methods. I like the term &ldquo;dunder&rdquo; methods better &mdash; it just means all methods which start and end with a <strong>d</strong>ouble <strong>under</strong>score. Examples are <strong>iter</strong> or <strong>contains</strong> . MagicMock has those defined, Mock doesn&rsquo;t. I would use MagicMock everywhere, except if the mocked object doesn&rsquo;t define any of the magic functions.</p>
<p>A core feature of mock classes is that they allow you to not only remove a dependency which is hard to test, but also to assert on the way the mock was interacted with. Typical methods are <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.assert_called">assert_called</a>(), <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.assert_called_with">assert_called_with</a>(), <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.assert_not_called">assert_not_called</a>().</p>
<h2 id="spec-autospec-spec_set">spec, autospec &amp; spec_set</h2>
<p>A part that is really bad about MagicMock is that you can do anything with it &mdash; including accessing non-existing attributes, calling non-existing methods or calling existing methods with the wrong count of parameters. The mock object is missing a <strong>spec</strong>ification. If you don&rsquo;t like that, use autospec=True when patching the object:</p>
<div class="highlight"><pre><span></span><code><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Or you can create a Mock like this:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">datetime</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">datetime</span><span class="p">)</span>

<span class="c1"># Not Ok!</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">foo</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">"/home/moose/.pyenv/versions/3.8.1/lib/python3.8/unittest/mock.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">635</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__getattr__</span>
    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">"Mock object has no attribute </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="n">Mock</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">'foo'</span>

<span class="c1"># That is ok:</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">datetime</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s1">'mock.datetime'</span> <span class="nb">id</span><span class="o">=</span><span class="s1">'139883597784544'</span><span class="o">&gt;</span>
</code></pre></div>
<p>The next parameter of patchis autospec. Where spec looks at the mocked object, autospec also looks at the attributes of that object (and their attributes and those attributes, &hellip;).</p>
<p>Finally, there is spec_set . That one prevents you from setting attributes that don&rsquo;t exist.</p>
<p>Usually, I would use autospec=True and spec_set=True everywhere. Code which uses introspection might be an example where you don&rsquo;t want that.</p>
<h2 id="pytests-monkeypatch">pytests monkeypatch</h2>
<p>monkeypatch is a fixture from pytest. I will explain what a fixture is in the next article. For now, just accept it as a parameter you can give to your tests without specifying it and pytest will take care of it. You don&rsquo;t even need to import anything.</p>
<p>For the credit card fraud example, it looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_is_credit_card_fraud_monkeypatch</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s2">"fraud_example.dark_magic"</span><span class="p">,</span> <span class="n">the_mock</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">fraud_example</span>

    <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"amount_usd"</span><span class="p">:</span> <span class="s2">"9999.99"</span><span class="p">,</span> <span class="s2">"overnight_shipping"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">is_fraud</span> <span class="o">=</span> <span class="n">fraud_example</span><span class="o">.</span><span class="n">is_credit_card_fraud</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_fraud</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>
<p>The question when you should use unittest.mock.patch and &mdash; if necessary &mdash; unittest.mock.Mock or pytests monkeypatch boils pretty much down to personal taste nowadays. The core Pythons patch / Mock only exist since Python 3.3 which, I guess, is a big part of the reason why monkeypatch exists in the first place.</p>
<h2 id="external-packages">External Packages</h2>
<p>There are a couple of packages designed for simplifying the patching and giving better mocks for well-known dependencies.</p>
<p>For example, you can use <a href="https://pypi.org/project/freezegun/">freezegun</a> for mocking the system time:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">freezegun</span>
<span class="kn">from</span> <span class="nn">mock_example</span> <span class="kn">import</span> <span class="n">generate_filename</span>


<span class="k">def</span> <span class="nf">test_generate_filename</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">freeze_time</span><span class="p">(</span><span class="s2">"1990-04-28"</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">generate_filename</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"1990-04-28"</span>
</code></pre></div>
<p>For boto3 / botocore (Cloud-stuff), there is <a href="https://pypi.org/project/moto/">moto</a>.</p>
<p>For <a href="https://pypi.org/project/requests/">requests</a> , there is <a href="https://pypi.org/project/responses/">responses</a> :</p>
<p><code>requests_example.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"http://ip.jsontest.com/"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_ip</span><span class="p">())</span>
</code></pre></div>
<p><code>test_requests_example.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">requests_example</span> <span class="kn">import</span> <span class="n">get_ip</span>
<span class="kn">import</span> <span class="nn">responses</span>


<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span> <span class="nf">test_get_ip</span><span class="p">():</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">"http://ip.jsontest.com/"</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"ip"</span><span class="p">:</span> <span class="s2">"123.456.789.0"</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_ip</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"ip"</span><span class="p">:</span> <span class="s2">"123.456.789.0"</span><span class="p">}</span>
</code></pre></div>
<h2 id="dependency-injection">Dependency Injection</h2>
<p>If the above sounded complicated, there is a simpler alternative: Dependency Injection. Essentially adding the external state explicitly as a parameter which makes it easy to adjust in tests. For example, the code from above could be:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">def</span> <span class="nf">generate_filename</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">now</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">now</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2">.png"</span>
</code></pre></div>
<p>Now testing is trivial:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">mock_example</span> <span class="kn">import</span> <span class="n">generate_filename</span>


<span class="k">def</span> <span class="nf">test_generate_filename</span><span class="p">():</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">generate_filename</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"1990-04-28.png"</span>
</code></pre></div>
<p>In some cases it feels very natural to apply such a pattern, in others it
doesn&rsquo;t. Do this only when it feels natural. For example, it&rsquo;s very unlikely
that I would ever pass a module as a parameter although it&rsquo;s possible. That
would just feel very weird.</p>
<h2 id="temporary-files-are-mocks-a-code-smell">Temporary files: Are Mocks a Code Smell?</h2>
<p>It depends very much on the details, but I like to mock as little as possible.
Simply for the reason that not mocking means that you test more of your system.
Strictly speaking you can&rsquo;t call the test a <em>unit test</em> anymore if you test
more than one unit. It would be an integration test then &mdash; but that is also
essential, right? You wouldn&rsquo;t be happy with BMW selling you a motor, some
seats and a steering wheel and claiming &ldquo;all units work&rdquo;. They need work
together. Extensive mocks might prevent you from testing how things work
together.</p>
<p>In an ideal world, you would have both: Unit tests which are very controlled
and in case of failure make it easy to narrow down the source of the error. And
integration / end-to-end tests which show that the complete system works.</p>
<p>There are also people who think that the need to mock is an indicator for a
need to refactor
(<a href="https://github.com/pytest-dev/pytest/issues/4576#issuecomment-449865322">discussion</a>).
Harry Percival gave the talk <a href="https://www.youtube.com/watch?v=rk-f3B-eMkI">Stop Using Mocks (for a
while)</a> at PyCon 2020 and pointed
out that testing code which is using mocks tends to be brittle as it is tightly
coupled to implementation details.</p>
<p>A good example where I usually don&rsquo;t mock anything are file system
interactions. If possible, I write the file just like it would be in the real
application. When the test is finished, the test needs to clean up as well. I
use the <a href="https://docs.python.org/3/library/tempfile.html">tempfile</a> module for
that.</p>
<h2 id="dependency-injection-randomness">Dependency Injection: Randomness</h2>
<p>Just like adding a time parameter for functions which use by default the current time might make your code way easier to test, adding a random_state parameter or a seed parameter to functions which use randomness helps.</p>
<p>Here are some ways to seed random number generators:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">random</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">random</span><span class="o">.</span><span class="kp">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<span class="mf">0.8444218515250481</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<span class="mf">0.5488135039273248</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="kp">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">random_state</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<span class="mf">0.5488135039273248</span>
</code></pre></div>
<p>Setting a random state / seed is also very helpful for debugging. If you
haven&rsquo;t heard of the Heisenbug or the Higgs-Bugson, you missed some
<a href="https://blog.codinghorror.com/new-programming-jargon/">programming jargon</a>.
And if your interested in research, reproducibility matters.</p>
<h2 id="terminology">Terminology</h2>
<ul>
<li><strong>Patching vs Mocking</strong>: Patching a function is adjusting it&rsquo;s functionality. In the context of unit testing we patch a dependency away; so we replace the dependency. Mocking is imitating. Usually we patch a function to use a mock we control instead of a dependency we don&rsquo;t control.</li>
<li><strong>Monkey patching vs Mocking</strong>: Within a development context, mocking is pretty clearly about unit testing (<a href="https://stackoverflow.com/a/2666006/562769">example</a>). However, monkey patching has several applications besides unit testing. For example, you can patch third party code during runtime if there is a small functionality missing or a part of the code is broken. You just extend the code. Monkey patching is used in the PyCharm debugger (<a href="https://youtu.be/ZpJxwpyJpq4?t=367">source</a>).</li>
<li><strong>Monkey patching vs pytest.monkeypatch</strong>: The first one is a general concept, the second one is a concrete function within pytest which applies monkey patching for unit tests.</li>
<li><strong>unittest.mock.patch vs pytest.monkeypatch</strong>: This is personal preference. I prefer to stick with built-ins whenever the third-party option does not have big advantages. In this case, I even think that the core Python unittest.mock.patch is cleaner. For this reason I didn&rsquo;t explain pytest.monkeypatch so far. If you like to see the differences, there is a nice <a href="https://krzysztofzuraw.com/blog/2016/mocks-monkeypatching-in-python.html">blog post</a> about it.</li>
</ul>
<h2 id="a-note-about-architecture">A note about Architecture</h2>
<p>To keep your code clean, it is often a good idea to wrap third party
dependencies. For example, you could have one module with deals with I/O. Or a
module which deals with API requests. Then you have a couple of modules which
might require a lot of mocking or where unit tests are pointless because the
interesting part is the integration with the third party. The rest of your code
stays easy to test, keeps the language you defined and cares about the objects
you know. This is called the <a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapter
pattern</a>.</p>
<h2 id="what-else-is-there">What else is there?</h2>
<ul>
<li>Other types of Mocks, such as <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.PropertyMock">PropertyMock</a> or</li>
<li><a href="https://pypi.org/project/pytest-mock/">pytest-mock</a> which provides the mocker fixture; I&rsquo;m not really sure though if this is mainly a left-over from the time before Python 3.3 or if it actually makes things easier.</li>
<li>The 3rd party package <a href="https://pypi.org/project/mock/">mock</a>, which should not be installed with Python 3.3+ as it was put in the standard library.</li>
</ul>
<p>If you want to learn more about the default mocks, have a look at the awesome
article by Yeray Diaz: <a href="https://medium.com/@yeraydiazdiaz/what-the-mock-cheatsheet-mocking-in-python-6a71db997832">What the mock? &mdash; A cheatsheet for mocking in Python</a>.</p>
<h2 id="whats-next">What&rsquo;s next?</h2>
<p>In part 1, you learned <a href="https://medium.com/swlh/unit-testing-in-python-basics-21a9a57418a0">the basics of Unit Testing in Python</a>. In this parts you learned how to patch dependencies to make code testable and what the standard mocks are.</p>
<p>In future articles, I will present:</p>
<ul>
<li>How to test Flask applications with Databases</li>
<li>How to structure Unit Tests</li>
<li>tox and nox</li>
<li>CI-Pipelines</li>
<li>Test Automation</li>
<li>Property-based Testing</li>
<li>Mutation Testing</li>
</ul>
            
            <div id="disqus_thread" class="no-print"></div>
<script>
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');

        s.src = '//martinthoma.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

            <hr/>
        </div>
        <section>
        <div class="col-sm-2 col-md-2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2020-07-09T17:00:00+02:00">Jul 9, 2020</time>
            <br/>
            by <a rel="author" class="vcard author post-author" itemprop="author" href="../author/martin-thoma/"><span class="fn" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name">Martin Thoma</span></span></a>
            <h4>Category</h4>
            <a class="category-link" href="../categories.html#code-ref">Code</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="../tags.html#dependency-injection-ref">dependency-injection
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#mock-ref">Mock
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#patching-ref">patching
                    <span>1</span>
</a></li>
                <li><a href="../tags.html#pytest-ref">pytest
                    <span>7</span>
</a></li>
                <li><a href="../tags.html#python-ref">Python
                    <span>132</span>
</a></li>
                <li><a href="../tags.html#unit-testing-ref">Unit Testing
                    <span>5</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="https://twitter.com/themoosemind" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="mailto:info@martin-thoma.de" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
    <a href="https://github.com/MartinThoma" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://stackoverflow.com/users/562769/martin-thoma" title="My Stackoverflow Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-stackoverflow sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="col-sm-1 col-md-1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer class="no-print">
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-subtitle"><span class="site-name">Martin Thoma</span> - A blog about Code, the Web and Cyberculture</li>
        <li><a href="https://martin-thoma.com/feeds/index.xml">RSS-Feed</a></li>
        <li><a href="http://www.martin-thoma.de/privacy.htm">Datenschutzerkl&auml;rung</a></li>
        <li><a href="http://www.martin-thoma.de/impressum.htm">Impressum</a></li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page" tabindex="-1">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page" tabindex="-1">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page" tabindex="-1">Talha Mansoor</a></li>
    </ul>
</div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
        <script>
(function(){
    'use strict';

    /*
    Create intra-page links
    Requires that your headings already have an `id` attribute set
    For every heading in your page, this adds a little anchor link `#` that you can click to get a permalink to the heading.
    Ignores `h1`, because you should only have one per page.
    The text content of the tag is used to generate the link, so it will fail "gracefully-ish" if you have duplicate heading text.

    Credit: https://gist.github.com/SimplGy/a229d25cdb19d7f21231
     */

    var headingNodes = [], results, link,
        tags = ['h2', 'h3', 'h4', 'h5', 'h6'];

    tags.forEach(function(tag){
        var contentTag = document.getElementById('contentAfterTitle');
      results = contentTag.getElementsByTagName(tag);
      Array.prototype.push.apply(headingNodes, results);
    });

    headingNodes.forEach(function(node){
      link = document.createElement('a');
      link.className = 'deepLink';
      link.textContent = ' ¶';
      link.href = '#' + node.getAttribute('id');
      node.appendChild(link);
    });

  })();
</script>
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>